- name: Check if linger is already set for user
  ansible.builtin.command: "loginctl show-user {{ linger_user }} -p Linger"
  register: linger_status
  changed_when: false
  failed_when: false

- name: Enable linger for user
  ansible.builtin.command: "loginctl enable-linger {{ linger_user }}"
  when:
    - linger_state == "enabled"
    - linger_status.stdout != "Linger=yes"
  become: true

- name: Disable linger for user
  ansible.builtin.command: "loginctl disable-linger {{ linger_user }}"
  when:
    - linger_state == "disabled"
    - linger_status.stdout == "Linger=yes"
  become: true

- name: Verify linger is set correctly
  ansible.builtin.command: "loginctl show-user {{ linger_user }} -p Linger"
  register: linger_verify
  failed_when: >
    (linger_state == "enabled" and linger_verify.stdout != "Linger=yes") or
    (linger_state == "disabled" and linger_verify.stdout != "Linger=no")
  changed_when: false
