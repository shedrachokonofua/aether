receivers:
{% if otlp_receiver_enabled | default(true) %}
  otlp:
    protocols:
      grpc:
        endpoint: "127.0.0.1:{{ otlp_receiver_grpc_port | default(4317) }}"
      http:
        endpoint: "127.0.0.1:{{ otlp_receiver_http_port | default(4318) }}"
{% endif %}
  journald:
    directory: /var/log/journal/
    storage: file_storage/journald_cursor_storage
    matches:
      - _UID: "1000"
{% for unit in monitored_systemd_units %}
      - _SYSTEMD_UNIT: {{ unit }}
{% endfor %}
  filelog:
    storage: file_storage/filelog_cursor_storage
    include:
{% for pattern in file_log_patterns %}
      - {{ pattern }}
{% endfor %}
  hostmetrics:
    collection_interval: {{ host_metrics_collection_interval | default('30s') }}
    initial_delay: {{ host_metrics_initial_delay | default('1s') }}
    scrapers:
      cpu:
      disk:
      filesystem:
      load:
      memory:
      network:
      paging:
      processes:
      process:
      system:
{% if has_podman_socket | default(false) %}
  podman_stats:
    endpoint: unix:///run/user/1000/podman/podman.sock
    collection_interval: {{ podman_metrics_collection_interval | default('15s') }}
    initial_delay: {{ podman_metrics_initial_delay | default('1s') }}
    timeout: 5s
{% endif %}
{% if has_docker_socket | default(false) %}
  docker_stats:
    endpoint: unix:///var/run/docker.sock
    api_version: "1.44"
    collection_interval: {{ docker_metrics_collection_interval | default('15s') }}
    initial_delay: {{ docker_metrics_initial_delay | default('1s') }}
    timeout: 5s
{% endif %}
{% if prometheus_scrape_configs | default([]) | length > 0 %}
  prometheus:
    config:
      scrape_configs:
{{ prometheus_scrape_configs | to_nice_yaml(indent=2) | indent(8, first=True) }}
{% endif %}

processors:
  batch:
    send_batch_size: 1000
    timeout: 10s
  resource:
    attributes:
      - key: host.name
        value: "{{ inventory_hostname }}"
        action: insert
      - key: service.name
        value: "{{ inventory_hostname }}"
        action: insert
      - key: os.type
        value: "{{ ansible_distribution }}"
        action: insert
      - key: os.version
        value: "{{ ansible_distribution_version }}"
        action: insert

extensions:
  file_storage/journald_cursor_storage:
    directory: {{ otel_collector_storage_path }}
  file_storage/filelog_cursor_storage:
    directory: {{ otel_collector_storage_path }}

exporters:
  otlphttp:
    endpoint: {{ otlp_endpoint }}

service:
  telemetry:
    # Only log warnings/errors - info level logs file discovery spam
    logs:
      level: warn
    metrics:
      readers:
        - periodic:
            exporter:
              otlp:
                protocol: http/protobuf
                endpoint: {{ otlp_endpoint }}
  extensions: [file_storage/journald_cursor_storage, file_storage/filelog_cursor_storage]
  pipelines:
    metrics:
      receivers: [{% if otlp_receiver_enabled | default(true) %}otlp, {% endif %}hostmetrics{% if has_podman_socket | default(false) %}, podman_stats{% endif %}{% if has_docker_socket | default(false) %}, docker_stats{% endif %}{% if prometheus_scrape_configs | default([]) | length > 0 %}, prometheus{% endif %}]
      processors: [batch, resource]
      exporters: [otlphttp]
    logs:
      receivers: [{% if otlp_receiver_enabled | default(true) %}otlp, {% endif %}journald, filelog]
      processors: [batch, resource]
      exporters: [otlphttp]
{% if otlp_receiver_enabled | default(true) %}
    traces:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [otlphttp]
{% endif %}
