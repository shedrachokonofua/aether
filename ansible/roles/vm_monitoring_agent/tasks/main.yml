---
# For VyOS systems using network_cli, we need to use SSH for system operations
- name: Setup monitoring agent tasks
  block:
    # Gather facts if not already gathered (needed for VyOS with network_cli)
    - name: Gather facts for system
      setup:
      when: ansible_os_family is not defined

    # Detect distribution family for package management
    - name: Check if system uses rpm-ostree
      stat:
        path: /usr/bin/rpm-ostree
      register: rpm_ostree_check

    - name: Check if Podman is installed
      stat:
        path: /usr/bin/podman
      register: podman_check

    - name: Set distribution facts
      set_fact:
        is_debian_based: "{{ ansible_os_family == 'Debian' or ansible_distribution in ['Debian', 'VyOS'] }}"
        is_fedora_based: "{{ ansible_os_family == 'RedHat' or ansible_distribution in ['Fedora'] }}"
        is_rpm_ostree_based: "{{ rpm_ostree_check.stat.exists or ansible_distribution in ['Bazzite'] }}"
        has_podman: "{{ podman_check.stat.exists | default(false) }}"

    # Enable system Podman socket if Podman is installed
    - name: Enable and start system Podman socket
      systemd:
        name: podman.socket
        enabled: yes
        state: started
        daemon_reload: yes
      become: true
      when: has_podman
      ignore_errors: true

    - name: Set Podman socket facts
      set_fact:
        has_podman_socket: "{{ has_podman }}"
        podman_socket_path: "/run/podman/podman.sock"

    # Detect NVIDIA GPU early (before config rendering)
    - name: Check if nvidia-smi is available
      command: which nvidia-smi
      register: nvidia_smi_check
      changed_when: false
      failed_when: false

    - name: Verify NVIDIA GPU presence
      command: nvidia-smi --query-gpu=name --format=csv,noheader
      register: nvidia_gpu_query
      changed_when: false
      failed_when: false
      when: nvidia_smi_check.rc == 0

    - name: Set GPU facts and add to scrape configs
      set_fact:
        has_nvidia_gpu: "{{ nvidia_smi_check.rc == 0 and nvidia_gpu_query.rc == 0 }}"
        prometheus_scrape_configs: "{{ prometheus_scrape_configs | default([]) + [gpu_scrape_config] }}"
      vars:
        gpu_scrape_config:
          job_name: "nvidia_gpu"
          scrape_interval: "{{ nvidia_gpu_exporter_scrape_interval }}"
          static_configs:
            - targets: ["localhost:{{ nvidia_gpu_exporter_port }}"]
      when:
        - nvidia_smi_check.rc == 0
        - nvidia_gpu_query.rc == 0

    - name: Display GPU information
      debug:
        msg: "Detected NVIDIA GPU(s): {{ nvidia_gpu_query.stdout_lines }}"
      when:
        - nvidia_smi_check.rc == 0
        - nvidia_gpu_query.rc == 0
        - nvidia_gpu_query.stdout_lines | length > 0

    # Install dependencies based on distribution
    - name: Install dependencies (Debian-based)
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
          - lsb-release
          - systemd
        state: present
        update_cache: yes
      become: true
      when: is_debian_based

    - name: Install dependencies (Fedora-based)
      dnf:
        name:
          - curl
          - ca-certificates
          - systemd
        state: present
      become: true
      when: is_fedora_based and not is_rpm_ostree_based

    - name: Check if required packages are installed (rpm-ostree systems)
      command: rpm -q {{ item }}
      register: rpm_check
      with_items:
        - curl
        - ca-certificates
      changed_when: false
      failed_when: false
      when: is_rpm_ostree_based

    - name: Install missing dependencies (rpm-ostree based systems like Bazzite)
      command: rpm-ostree install --apply-live --allow-inactive {{ item.item }}
      with_items: "{{ rpm_check.results }}"
      when:
        - is_rpm_ostree_based
        - item.rc != 0
      become: true
      register: rpm_ostree_install
      changed_when: "'No change' not in rpm_ostree_install.stdout"

    # Install OTEL Collector
    - name: Check if otelcol-contrib is installed
      stat:
        path: "{{ otel_collector_binary_path }}"
      register: otel_collector_installed

    - name: Download OTEL Collector Contrib
      get_url:
        url: "{{ otel_collector_download_url }}"
        dest: /tmp/otelcol-contrib.tar.gz
      when: not otel_collector_installed.stat.exists

    - name: Extract OTEL Collector
      unarchive:
        src: /tmp/otelcol-contrib.tar.gz
        dest: /tmp
        remote_src: yes
        creates: /tmp/otelcol-contrib
      when: not otel_collector_installed.stat.exists

    - name: Install OTEL Collector binary
      copy:
        src: /tmp/otelcol-contrib
        dest: "{{ otel_collector_binary_path }}"
        mode: "0755"
        remote_src: yes
      become: true
      when: not otel_collector_installed.stat.exists

    # Create directories
    - name: Create monitoring agent configuration directory
      file:
        path: "{{ monitoring_agent_config_dir }}"
        state: directory
        mode: "0755"
      become: true

    - name: Create OTEL storage directory
      file:
        path: "{{ otel_collector_storage_path }}"
        state: directory
        mode: "0755"
        owner: "{{ monitoring_agent_service_user }}"
        group: "{{ monitoring_agent_service_user }}"
      become: true

    # Deploy configuration
    - name: Create OTEL config file
      template:
        src: otel-collector-config.yml.j2
        dest: "{{ otel_collector_config_path }}"
        mode: "0644"
      become: true
      notify: restart otel collector

    # Create systemd service for OTEL Collector
    - name: Create OTEL Collector systemd service
      template:
        src: otel-collector.service.j2
        dest: /etc/systemd/system/aether-otel-collector.service
        mode: "0644"
      become: true
      notify: restart otel collector

    # Reload systemd and start services
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes
      become: true

    - name: Enable and start OTEL Collector
      systemd:
        name: aether-otel-collector
        enabled: yes
        state: started
      become: true

    # Install NVIDIA GPU Exporter (if detected earlier)
    - name: Install NVIDIA GPU Exporter
      include_tasks: nvidia_gpu_exporter.yml
      when: has_nvidia_gpu | default(false)

    # Cleanup temporary files
    - name: Clean up temporary files
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "/tmp/otelcol-contrib.tar.gz"
        - "/tmp/otelcol-contrib"
      become: true
      ignore_errors: true
