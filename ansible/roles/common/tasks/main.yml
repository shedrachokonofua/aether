- name: Load VM config
  include_vars:
    file: "/workspace/config/vm.yml"
    name: vm

- name: Load secrets
  include_vars:
    file: "/workspace/secrets/secrets.yml"
    name: secrets

- name: Load tf outputs
  include_vars:
    file: "/workspace/secrets/tf-outputs.json"
    name: tf_outputs

- name: Find AWS stack output files
  ansible.builtin.find:
    paths: "/workspace/secrets/aws"
    patterns: "*.yml"
  register: aws_files
  delegate_to: localhost
  ignore_errors: true

- name: Load AWS stack outputs
  ansible.builtin.include_vars:
    file: "{{ item.path }}"
    name: "aws_{{ item.path | basename | replace('.yml', '') | replace('-', '_') }}"
  loop: "{{ aws_files.files | default([]) }}"
  ignore_errors: true

- name: Load base authorized_keys
  set_fact:
    base_ssh_authorized_keys: >-
      {{
        lookup('file', '/workspace/config/authorized_keys').splitlines()
        | reject('equalto', '')
        | reject('match', '^#')
        | list
      }}

- name: Set ssh_authorized_keys to base by default
  set_fact:
    ssh_authorized_keys: "{{ base_ssh_authorized_keys }}"

- name: Override ssh_authorized_keys with Terraform output if valid
  set_fact:
    ssh_authorized_keys: "{{ tf_outputs.ssh_authorized_keys.value }}"
  when:
    - tf_outputs is defined
    - tf_outputs.ssh_authorized_keys is defined
    - tf_outputs.ssh_authorized_keys.value is defined
    - tf_outputs.ssh_authorized_keys.value is not none

- name: Strip newlines from ssh_authorized_keys
  set_fact:
    ssh_authorized_keys: "{{ ssh_authorized_keys | map('regex_replace', '\n', '') }}"
