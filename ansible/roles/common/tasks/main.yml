- name: Load VM config
  include_vars:
    file: "{{ aether_root }}/config/vm.yml"
    name: vm
  tags: [always]

- name: Load tenant config
  include_vars:
    file: "{{ aether_root }}/config/tenants.yml"
  tags: [always]

- name: Load secrets
  community.sops.load_vars:
    file: "{{ aether_root }}/secrets/secrets.yml"
    name: secrets
  tags: [always]

- name: Load tf outputs
  include_vars:
    file: "{{ aether_root }}/secrets/tf-outputs.json"
    name: tf_outputs
  tags: [always]

- name: Check if AWS stack output directory exists
  ansible.builtin.stat:
    path: "{{ aether_root }}/secrets/aws"
  register: aws_dir
  delegate_to: localhost
  become: false

- name: Find AWS stack output files
  ansible.builtin.find:
    paths: "{{ aether_root }}/secrets/aws"
    patterns: "*.yml"
  register: aws_files
  delegate_to: localhost
  become: false
  when: aws_dir.stat.exists and aws_dir.stat.isdir

- name: Load AWS stack outputs
  ansible.builtin.include_vars:
    file: "{{ item.path }}"
    name: "aws_{{ item.path | basename | replace('.yml', '') | replace('-', '_') }}"
  loop: "{{ aws_files.files | default([]) }}"
  when: aws_files.files is defined

- name: Load base authorized_keys
  set_fact:
    base_ssh_authorized_keys: >-
      {{
        lookup('file', aether_root + '/config/authorized_keys').splitlines()
        | reject('equalto', '')
        | reject('match', '^#')
        | list
      }}

- name: Set ssh_authorized_keys to base by default
  set_fact:
    ssh_authorized_keys: "{{ base_ssh_authorized_keys }}"

- name: Override ssh_authorized_keys with Terraform output if valid
  set_fact:
    ssh_authorized_keys: "{{ tf_outputs.ssh_authorized_keys.value }}"
  when:
    - tf_outputs is defined
    - tf_outputs.ssh_authorized_keys is defined
    - tf_outputs.ssh_authorized_keys.value is defined
    - tf_outputs.ssh_authorized_keys.value is not none

- name: Strip newlines from ssh_authorized_keys
  set_fact:
    ssh_authorized_keys: "{{ ssh_authorized_keys | map('regex_replace', '\n', '') }}"
