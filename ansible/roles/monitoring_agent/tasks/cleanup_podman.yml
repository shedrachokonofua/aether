---
# Clean up old Podman-based monitoring setup

- name: Check if old Podman pod service exists
  stat:
    path: /etc/systemd/system/aether-monitoring-agent-pod.service
  register: old_pod_service

- name: Stop old Podman monitoring services
  systemd:
    name: aether-monitoring-agent-pod
    state: stopped
    enabled: no
  become: true
  when: old_pod_service.stat.exists
  ignore_errors: true

- name: Remove old Podman pod and containers
  containers.podman.podman_pod:
    name: aether-monitoring-agent
    state: absent
  become: true
  ignore_errors: true

- name: Remove old Podman containers
  containers.podman.podman_container:
    name: "{{ item }}"
    state: absent
  become: true
  with_items:
    - aether-monitoring-agent-node-exporter
    - aether-monitoring-agent-otel-collector
  ignore_errors: true

- name: Remove old quadlet files
  file:
    path: "{{ item }}"
    state: absent
  become: true
  with_items:
    - /etc/containers/systemd/aether-monitoring-agent.pod
    - /etc/containers/systemd/aether-monitoring-agent-node-exporter.container
    - /etc/containers/systemd/aether-monitoring-agent-otel-collector.container
  ignore_errors: true

- name: Remove old container images
  containers.podman.podman_image:
    name: "{{ item }}"
    state: absent
  become: true
  with_items:
    - aether-monitoring-agent-otel-collector
    - docker.io/prom/node-exporter:latest
  ignore_errors: true

- name: Remove old Podman configuration files
  file:
    path: "{{ item }}"
    state: absent
  become: true
  with_items:
    - /etc/aether-monitoring-agent/otel
    - /etc/aether-monitoring-agent/otel-config.yml # Old config location
  ignore_errors: true

- name: Check if old storage directory exists
  stat:
    path: /var/lib/otelcol/storage
  register: old_storage

- name: Clean up old storage directory if empty or only contains old data
  file:
    path: /var/lib/otelcol/storage
    state: absent
  become: true
  when: old_storage.stat.exists
  ignore_errors: true

- name: Reload systemd after cleanup
  systemd:
    daemon_reload: yes
  become: true
  when: old_pod_service.stat.exists
