---
- name: Install libdnf5
  become: true
  command: dnf -y install python3-libdnf5
  args:
    creates: /usr/lib64/python*/site-packages/libdnf5
  when: ansible_distribution != "Amazon"

# Configure automatic updates when enabled
- when: dnf_enable_automatic_updates | bool
  block:
    - name: Install dnf-automatic
      become: true
      dnf:
        name: dnf-automatic
        state: present

    - name: Configure dnf-automatic
      become: true
      template:
        src: automatic.conf.j2
        dest: /etc/dnf/automatic.conf
        backup: yes
        mode: "0644"
      notify: restart dnf-automatic timer

    - name: Create systemd timer override directory
      become: true
      file:
        path: /etc/systemd/system/dnf-automatic.timer.d
        state: directory
        mode: "0755"

    - name: Configure dnf-automatic timer
      become: true
      template:
        src: dnf-automatic-timer-override.conf.j2
        dest: /etc/systemd/system/dnf-automatic.timer.d/override.conf
        mode: "0644"
      notify:
        - reload systemd
        - restart dnf-automatic timer

- name: Perform Fedora system upgrade
  when:
    - ansible_distribution == "Fedora"
    - dnf_system_upgrade_enabled | bool
  block:
    - name: Download Fedora system upgrade packages
      become: true
      command:
        cmd: >
          dnf system-upgrade download
          --releasever={{ dnf_system_upgrade_releasever }}
          -y
      register: dnf_system_upgrade_download
      changed_when: dnf_system_upgrade_download.rc == 0
      ignore_errors: true

    - name: Trigger Fedora system upgrade reboot
      become: true
      command:
        cmd: dnf5 offline-upgrade reboot -y
      when: dnf_system_upgrade_download.rc == 0
      ignore_errors: true

    - name: Wait for system to reboot and complete upgrade
      wait_for_connection:
        timeout: 30
      register: wait_result
      until: wait_result is success
      retries: 20
      delay: 5
      when: dnf_system_upgrade_download.rc == 0
