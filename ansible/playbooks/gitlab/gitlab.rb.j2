external_url 'https://gitlab.home.shdr.ch'
gitlab_rails['gitlab_shell_ssh_port'] = 2222
gitlab_rails['initial_root_password'] = "{{ secrets.gitlab.root_password }}"
nginx['listen_port'] = 80
nginx['listen_https'] = false
letsencrypt['enable'] = false
gitlab_rails['import_sources'] = ['github']
registry_external_url 'https://registry.gitlab.home.shdr.ch'
gitlab_rails['registry_enabled'] = true
registry['enable'] = true
registry_nginx['listen_port'] = 5050
registry_nginx['listen_https'] = false
gitlab_rails['registry_issuer'] = "gitlab-issuer"
gitlab_rails['registry_key_path'] = "/var/opt/gitlab/gitlab-rails/certificate.key"
pages_external_url 'https://pages.gitlab.home.shdr.ch'
gitlab_pages['enable'] = true
pages_nginx['listen_port'] = 3210
pages_nginx['listen_https'] = false

# SMTP configuration
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "{{ vm.messaging_stack.ip }}"
gitlab_rails['smtp_port'] = {{ vm.messaging_stack.ports.smtp }}
gitlab_rails['smtp_domain'] = "shdr.ch"
gitlab_rails['smtp_authentication'] = false
gitlab_rails['smtp_enable_starttls_auto'] = false
gitlab_rails['gitlab_email_from'] = 'gitlab@shdr.ch'
gitlab_rails['gitlab_email_reply_to'] = 'noreply@shdr.ch'

# OIDC SSO via Keycloak
gitlab_rails['omniauth_enabled'] = true
gitlab_rails['omniauth_allow_single_sign_on'] = ['openid_connect']
gitlab_rails['omniauth_sync_email_from_provider'] = 'openid_connect'
gitlab_rails['omniauth_sync_profile_from_provider'] = ['openid_connect']
gitlab_rails['omniauth_sync_profile_attributes'] = ['email', 'name']
gitlab_rails['omniauth_block_auto_created_users'] = false
gitlab_rails['omniauth_auto_link_user'] = ['openid_connect']
gitlab_rails['omniauth_providers'] = [
  {
    name: "openid_connect",
    label: "Aether",
    args: {
      name: "openid_connect",
      scope: ["openid", "profile", "email", "roles"],
      response_type: "code",
      issuer: "https://auth.shdr.ch/realms/aether",
      discovery: true,
      client_auth_method: "basic",
      uid_field: "preferred_username",
      send_scope_to_token_endpoint: true,
      pkce: true,
      client_options: {
        identifier: "gitlab",
        secret: "{{ tf_outputs.keycloak_gitlab_client_secret.value }}",
        redirect_uri: "https://gitlab.home.shdr.ch/users/auth/openid_connect/callback"
      },
      admin_groups: ["admin"],
      required_groups: ["gitlab-user", "admin"]
    }
  }
]

gitlab_kas['enable'] = true
