---
- name: Deploy monitoring stack
  hosts: monitoring-stack
  gather_facts: true
  vars:
    # Disable OTLP receiver in vm_monitoring_agent - central collector handles it
    otlp_receiver_enabled: false
  roles:
    - common
    - vm_baseline
    - dnf
    - vm_monitoring_agent
  tasks:
    # === Directory Setup ===
    - name: Create prometheus directory
      become: true
      file:
        path: ./prometheus/data
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      tags: [prometheus]

    - name: Create loki directory
      become: true
      file:
        path: ./loki/data
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      tags: [loki]

    - name: Create tempo directory
      become: true
      file:
        path: ./tempo
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      tags: [tempo]

    - name: Create otel directory
      become: true
      file:
        path: ./otel
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      tags: [otel]

    - name: Create grafana directory
      become: true
      file:
        path: ./grafana/provisioning
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      tags: [grafana]

    - name: Create pve-exporter directory
      become: true
      file:
        path: ./pve-exporter
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      tags: [pve-exporter]

    - name: Create pbs-exporter directory
      become: true
      file:
        path: ./pbs-exporter
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      tags: [pbs-exporter]

    - name: Create clickhouse directories
      become: true
      file:
        path: "{{ item }}"
        state: directory
        mode: "0777"
        owner: aether
        group: aether
      loop:
        - ./clickhouse/data
        - ./clickhouse/init
      tags: [clickhouse]

    # === Configuration Files ===
    - name: Copy prometheus config
      copy:
        src: ./prometheus.yml
        dest: ./prometheus/prometheus.yml
        mode: "0755"
      tags: [prometheus]

    - name: Create loki config
      copy:
        src: ./loki_config.yml
        dest: ./loki/loki_config.yml
        mode: "0755"
      tags: [loki]

    - name: Create tempo config
      copy:
        src: ./tempo.yml
        dest: ./tempo/tempo.yml
        mode: "0755"
      tags: [tempo]

    - name: Create otel config
      template:
        src: ./otel_config.yml.j2
        dest: ./otel/otel_config.yml
        mode: "0755"
      tags: [otel]

    - name: Create grafana config
      template:
        src: ./grafana/grafana.ini.j2
        dest: ./grafana/grafana.ini
        mode: "0755"
      tags: [grafana]

    - name: Create grafana provisioning directories
      file:
        path: "./grafana/provisioning/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - datasources
        - dashboards
      tags: [grafana]

    - name: Template grafana datasources
      template:
        src: ./grafana/provisioning/datasources/datasource.yml.j2
        dest: ./grafana/provisioning/datasources/datasource.yml
        mode: "0644"
      tags: [grafana]

    - name: Copy grafana dashboards provisioning
      copy:
        src: ./grafana/provisioning/dashboards/
        dest: ./grafana/provisioning/dashboards/
        mode: "0755"
      tags: [grafana]

    - name: Create PVE exporter config
      copy:
        content: |
          default:
            user: {{ secrets.proxmox.cluster_username }}
            token_name: {{ secrets.proxmox.monitoring_token_id }}
            token_value: "{{ secrets.proxmox.monitoring_secret }}"
            verify_ssl: false
        dest: ./pve-exporter/pve.yml
        mode: "0644"
      tags: [pve-exporter]

    - name: Copy ClickHouse init scripts
      copy:
        src: ./clickhouse/
        dest: ./clickhouse/init/
        mode: "0644"
      tags: [clickhouse]

    # === Pods ===
    - name: Create monitoring stack pod
      containers.podman.podman_pod:
        name: monitoring-stack
        ports:
          - "{{ vm.monitoring_stack.ports.grafana }}:3000"
          - "{{ vm.monitoring_stack.ports.prometheus }}:9090"
          - "{{ vm.monitoring_stack.ports.loki }}:3100"
          - "{{ vm.monitoring_stack.ports.otel_grpc }}:4317"
          - "{{ vm.monitoring_stack.ports.otel_http }}:4318"
          - "{{ vm.monitoring_stack.ports.otel_metrics }}:8888"
          - "{{ vm.monitoring_stack.ports.otel_prometheus }}:8889"
          - "{{ vm.monitoring_stack.ports.clickhouse }}:8123" # ClickHouse HTTP/Play UI
          - "9221:9221" # PVE Exporter
          - "10019:10019" # PBS Exporter
        state: quadlet
        restart_policy: on-failure
        recreate: true
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target
      tags:
        [
          prometheus,
          loki,
          tempo,
          otel,
          grafana,
          clickhouse,
          pve-exporter,
          pbs-exporter,
          monitoring-pod,
        ]

    # === Volumes ===
    - name: Create prometheus storage volume
      containers.podman.podman_volume:
        name: prometheus_storage
        state: quadlet
      tags: [prometheus]

    - name: Create grafana storage volume
      containers.podman.podman_volume:
        name: grafana_storage
        state: quadlet
      tags: [grafana]

    - name: Create clickhouse storage volume
      containers.podman.podman_volume:
        name: clickhouse_storage
        state: quadlet
      tags: [clickhouse]

    # === Containers ===
    - name: Start prometheus
      containers.podman.podman_container:
        name: prometheus
        image: docker.io/prom/prometheus:latest
        pod: monitoring-stack.pod
        volumes:
          - prometheus_storage.volume:/prometheus
          - /home/aether/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:Z
        command:
          - "--config.file=/etc/prometheus/prometheus.yml"
          - "--storage.tsdb.path=/prometheus"
          - "--web.console.libraries=/etc/prometheus/console_libraries"
          - "--web.console.templates=/etc/prometheus/consoles"
          - "--web.enable-lifecycle"
        state: quadlet
      tags: [prometheus]

    - name: Start Loki
      containers.podman.podman_container:
        name: loki
        image: docker.io/grafana/loki:latest
        pod: monitoring-stack.pod
        pull: always
        command:
          - "-config.file=/etc/loki/config.yml"
        volumes:
          - /home/aether/loki/loki_config.yml:/etc/loki/config.yml:Z
          - /home/aether/loki/data:/var/lib/loki:Z
        state: quadlet
      tags: [loki]

    - name: Start tempo
      containers.podman.podman_container:
        name: tempo
        image: docker.io/grafana/tempo:latest
        pod: monitoring-stack.pod
        pull: always
        command:
          - "-config.file=/etc/tempo.yaml"
        volumes:
          - /home/aether/tempo/tempo.yml:/etc/tempo.yaml:Z
        state: quadlet
      tags: [tempo]

    - name: Start otel collector
      containers.podman.podman_container:
        name: otel_collector
        image: docker.io/otel/opentelemetry-collector-contrib:latest
        pod: monitoring-stack.pod
        pull: always
        volumes:
          - /home/aether/otel/otel_config.yml:/etc/otelcol-contrib/config.yaml:Z
        state: quadlet
      tags: [otel]

    - name: Start grafana
      containers.podman.podman_container:
        name: grafana
        pod: monitoring-stack.pod
        image: docker.io/grafana/grafana:latest
        pull: always
        state: quadlet
        volumes:
          - /home/aether/grafana/grafana.ini:/etc/grafana/grafana.ini:Z
          - /home/aether/grafana/provisioning:/etc/grafana/provisioning:Z
          - grafana_storage.volume:/var/lib/grafana:Z
        env:
          GF_INSTALL_PLUGINS: grafana-clickhouse-datasource
      tags: [grafana]

    - name: Start PVE exporter
      containers.podman.podman_container:
        name: pve_exporter
        pod: monitoring-stack.pod
        image: docker.io/prompve/prometheus-pve-exporter:latest
        pull: always
        state: quadlet
        volumes:
          - /home/aether/pve-exporter/pve.yml:/etc/prometheus/pve.yml:Z
      tags: [pve-exporter]

    - name: Start PBS exporter
      containers.podman.podman_container:
        name: pbs_exporter
        pod: monitoring-stack.pod
        image: ghcr.io/natrontech/pbs-exporter:latest
        pull: always
        state: quadlet
        env:
          PBS_ENDPOINT: "https://{{ vm.backup_stack.ip }}:8007"
          PBS_USERNAME: "{{ secrets.pbs.monitoring_user }}"
          PBS_API_TOKEN: "{{ secrets.pbs.monitoring_secret }}"
          PBS_API_TOKEN_NAME: "{{ secrets.pbs.monitoring_token_id }}"
          PBS_INSECURE: "true"
          PBS_LISTEN_ADDRESS: ":10019"
      tags: [pbs-exporter]

    - name: Start ClickHouse
      containers.podman.podman_container:
        name: clickhouse
        pod: monitoring-stack.pod
        image: docker.io/clickhouse/clickhouse-server:latest
        pull: always
        state: quadlet
        volumes:
          - clickhouse_storage.volume:/var/lib/clickhouse:Z
          - /home/aether/clickhouse/init:/docker-entrypoint-initdb.d:Z
        env:
          CLICKHOUSE_USER: aether
          CLICKHOUSE_PASSWORD: "{{ secrets.clickhouse.password }}"
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"
      tags: [clickhouse]

    # === Systemd ===
    - name: Reload systemd
      systemd:
        daemon_reload: yes
        scope: user
      tags:
        [
          prometheus,
          loki,
          tempo,
          otel,
          grafana,
          clickhouse,
          pve-exporter,
          pbs-exporter,
          systemd,
        ]

    - name: Start monitoring stack quadlet
      systemd:
        name: monitoring-stack-pod
        state: restarted
        scope: user
      tags:
        [
          prometheus,
          loki,
          tempo,
          otel,
          grafana,
          clickhouse,
          pve-exporter,
          pbs-exporter,
          monitoring-pod,
        ]
