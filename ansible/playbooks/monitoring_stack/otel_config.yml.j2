receivers:
  otlp:
    protocols:
      grpc:
        endpoint: "0.0.0.0:4317"
      http:
        endpoint: "0.0.0.0:4318"

processors:
  batch:
    timeout: 10s
    send_batch_size: 2048
    send_batch_max_size: 4096

  # Selectively promote essential resource attributes to metric labels
  # This avoids the cardinality explosion from full resource_to_telemetry_conversion
  transform/metrics:
    metric_statements:
      - context: datapoint
        statements:
          # Host/service identification
          - set(attributes["host_name"], resource.attributes["host.name"]) where resource.attributes["host.name"] != nil
          - set(attributes["service_name"], resource.attributes["service.name"]) where resource.attributes["service.name"] != nil
          - set(attributes["exported_job"], resource.attributes["service.name"]) where resource.attributes["service.name"] != nil
          # Container attributes for per-container breakdown
          - set(attributes["container_name"], resource.attributes["container.name"]) where resource.attributes["container.name"] != nil
          - set(attributes["container_image_name"], resource.attributes["container.image.name"]) where resource.attributes["container.image.name"] != nil
          - set(attributes["container_id"], resource.attributes["container.id"]) where resource.attributes["container.id"] != nil
          # Tenant scoping
          - set(attributes["service_namespace"], resource.attributes["service.namespace"]) where resource.attributes["service.namespace"] != nil

connectors:
  # Route logs based on source - single decision point
  routing/logs:
    default_pipelines: [logs/loki]
    error_mode: ignore
    table:
      - context: resource
        condition: attributes["log.source"] == "zeek"
        pipelines: [logs/clickhouse/zeek]
      - context: resource
        condition: attributes["log.source"] == "suricata"
        pipelines: [logs/clickhouse/suricata]

  # Route traces by tenant for Tempo multi-tenancy
  routing/traces:
    default_pipelines: [traces/default]
    error_mode: ignore
    table:
{% for tenant in tenants %}
      - context: resource
        condition: attributes["service.namespace"] == "{{ tenant.name }}"
        pipelines: [traces/{{ tenant.name }}]
{% endfor %}

exporters:
  prometheus:
    endpoint: "0.0.0.0:8889"
    send_timestamps: true
    metric_expiration: 5m
    resource_to_telemetry_conversion:
      enabled: false
    add_metric_suffixes: false

  otlphttp/loki:
    endpoint: http://localhost:3100/otlp

  otlp/tempo:
    endpoint: "localhost:24317"
    tls:
      insecure: true
    headers:
      X-Scope-OrgID: aether

{% for tenant in tenants %}
  otlp/tempo-{{ tenant.name }}:
    endpoint: "localhost:24317"
    tls:
      insecure: true
    headers:
      X-Scope-OrgID: "{{ tenant.name }}"
{% endfor %}

  clickhouse/zeek:
    endpoint: tcp://localhost:9000
    username: aether
    password: "{{ secrets.clickhouse.password }}"
    database: zeek
    async_insert: true
    compress: lz4
    create_schema: false
    logs_table_name: ingest
    timeout: 10s
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

  clickhouse/suricata:
    endpoint: tcp://localhost:9000
    username: aether
    password: "{{ secrets.clickhouse.password }}"
    database: suricata
    async_insert: true
    compress: lz4
    create_schema: false
    logs_table_name: ingest
    timeout: 10s
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

service:
  pipelines:
    metrics:
      receivers: [otlp]
      processors: [transform/metrics, batch]
      exporters: [prometheus]

    # Ingest logs and route based on source
    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [routing/logs]

    # Zeek logs -> ClickHouse
    logs/clickhouse/zeek:
      receivers: [routing/logs]
      exporters: [clickhouse/zeek]

    # Suricata logs -> ClickHouse
    logs/clickhouse/suricata:
      receivers: [routing/logs]
      exporters: [clickhouse/suricata]

    # All other logs -> Loki (default)
    logs/loki:
      receivers: [routing/logs]
      exporters: [otlphttp/loki]

    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [routing/traces]

    traces/default:
      receivers: [routing/traces]
      exporters: [otlp/tempo]

{% for tenant in tenants %}
    traces/{{ tenant.name }}:
      receivers: [routing/traces]
      exporters: [otlp/tempo-{{ tenant.name }}]
{% endfor %}
