---
- name: Deploy IoT Management Stack
  hosts: iot-management-stack
  gather_facts: true
  vars:
    ha_config_dir: "/home/aether/homeassistant/config"
    home_assistant_timezone: "America/Toronto"
  roles:
    - common
    - vm_baseline
    - dnf
    - role: monitoring_agent
      prometheus_scrape_configs:
        - job_name: "homeassistant"
          scrape_interval: 30s
          metrics_path: /api/prometheus
          static_configs:
            - targets: ["localhost:8123"]
          authorization:
            credentials: "{{ secrets.homeassistant.telemetry_token }}"

  tasks:
    - name: Install dependencies
      become: true
      dnf:
        name:
          - usbutils
        state: present

    - name: Ensure Z-Wave device is initialized
      block:
        - name: Check if Z-Wave device exists
          stat:
            path: /dev/ttyUSB0
          register: zwave_device

        - name: Initialize Z-Wave device if needed
          shell: echo "10c4 ea60" > /sys/bus/usb-serial/drivers/generic/new_id
          become: true
          when: not zwave_device.stat.exists

    - name: Ensure proper permissions on Z-Wave device
      become: true
      file:
        path: /dev/ttyUSB0
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_id }}"
        mode: "0666"
      when: zwave_device.stat.exists

    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ ha_config_dir }}"
        - /home/aether/zwavejs

    - name: Write main home assistant configuration file
      copy:
        src: "./ha_config.yml"
        dest: "{{ ha_config_dir }}/configuration.yaml"
        mode: "0644"

    - name: Touch other home assistant config files
      file:
        path: "{{ item }}"
        state: touch
      loop:
        - "{{ ha_config_dir }}/automations.yaml"
        - "{{ ha_config_dir }}/scripts.yaml"
        - "{{ ha_config_dir }}/scenes.yaml"

    - name: Create the Home Assistant pod using quadlet
      containers.podman.podman_pod:
        name: iot-management-stack
        network: host
        state: quadlet
        restart_policy: on-failure
        recreate: true
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target

    - name: Start Home Assistant container
      containers.podman.podman_container:
        name: homeassistant
        image: ghcr.io/home-assistant/home-assistant:stable
        pod: iot-management-stack.pod
        volumes:
          - "{{ ha_config_dir }}:/config:Z"
          - /run/dbus:/run/dbus:ro
        env:
          TZ: "{{ home_assistant_timezone }}"
        state: quadlet

    - name: Write Z-Wave settings file
      template:
        src: ./zwave_settings.json.j2
        dest: /home/aether/zwavejs/settings.json
        mode: "0644"

    - name: Start Z-Wave JS container
      containers.podman.podman_container:
        name: zwavejs-ui
        image: docker.io/zwavejs/zwave-js-ui:latest
        pod: iot-management-stack.pod
        privileged: true
        volumes:
          - /home/aether/zwavejs:/usr/src/app/store:Z
          - /dev/ttyUSB0:/dev/zwave:Z
        tty: true
        env:
          SESSION_SECRET: "{{ secrets.zwave.session_secret }}"
        state: quadlet

    - name: Reload systemd user configuration
      ansible.builtin.systemd:
        daemon_reload: yes
        scope: user

    - name: Ensure iot-management-stack pod service is started and enabled
      ansible.builtin.systemd:
        name: iot-management-stack-pod.service
        state: restarted
        enabled: yes
        scope: user

    - name: Check if HACS is already installed
      ansible.builtin.stat:
        path: "{{ ha_config_dir }}/custom_components/hacs"
      register: hacs_installed

    - name: Install Home Assistant Community Store
      shell: |
        podman exec homeassistant bash -c "wget -O - https://get.hacs.xyz | bash -"
      when: not hacs_installed.stat.exists
