---
- name: Configure SeaweedFS
  hosts: seaweedfs
  become: true
  roles:
    - common
  vars:
    # SeaweedFS release tag, e.g. "3.90"
    seaweedfs_version: "3.90"

    seaweedfs_download_url: "https://github.com/seaweedfs/seaweedfs/releases/download/{{ seaweedfs_version }}/linux_amd64.tar.gz"
    seaweedfs_install_root: "/opt/seaweedfs"
    seaweedfs_install_dir: "{{ seaweedfs_install_root }}/{{ seaweedfs_version }}"
    seaweedfs_bin: "{{ seaweedfs_install_dir }}/weed"

    seaweedfs_user: "seaweed"
    seaweedfs_group: "seaweed"

    seaweedfs_config_dir: "/etc/seaweedfs"
    seaweedfs_data_dir: "/var/lib/seaweedfs"

    seaweedfs_master_dir: "{{ seaweedfs_data_dir }}/master"
    seaweedfs_filer_dir: "{{ seaweedfs_data_dir }}/filer"

    seaweedfs_volume_nvme_dir: "/mnt/nvme/seaweedfs/volumes"
    seaweedfs_volume_hdd_dir: "/mnt/hdd/seaweedfs/volumes"
    seaweedfs_volume_index_dir: "/mnt/nvme/seaweedfs/idx"

    # To avoid burning through volume IDs when using many buckets/collections.
    # Each bucket maps to a collection by default.
    seaweedfs_master_volume_size_limit_mb: 1024

    seaweedfs_ip: "{{ vm.seaweedfs.ip }}"
    seaweedfs_gateway: "{{ vm.seaweedfs.gateway }}"
    seaweedfs_port_master: "{{ vm.seaweedfs.ports.master }}"
    seaweedfs_port_filer: "{{ vm.seaweedfs.ports.filer }}"
    seaweedfs_port_s3: "{{ vm.seaweedfs.ports.s3 }}"
    seaweedfs_port_volume: 8080

    seaweedfs_security_toml_path: "{{ seaweedfs_config_dir }}/security.toml"
    seaweedfs_s3_config_path: "{{ seaweedfs_config_dir }}/s3.json"

    # S3 admin credentials from secrets.yml
    seaweedfs_s3_admin_access_key: "{{ secrets.seaweedfs.s3_admin_access_key }}"
    seaweedfs_s3_admin_secret_key: "{{ secrets.seaweedfs.s3_admin_secret_key }}"

  tasks:
    - name: Install required packages
      ansible.builtin.dnf:
        name:
          - curl
          - tar
        state: present

    - name: Ensure SeaweedFS group exists
      ansible.builtin.group:
        name: "{{ seaweedfs_group }}"
        system: true

    - name: Ensure SeaweedFS user exists
      ansible.builtin.user:
        name: "{{ seaweedfs_user }}"
        group: "{{ seaweedfs_group }}"
        system: true
        shell: /sbin/nologin
        create_home: false

    - name: Ensure install root exists
      ansible.builtin.file:
        path: "{{ seaweedfs_install_root }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Ensure install dir exists
      ansible.builtin.file:
        path: "{{ seaweedfs_install_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Download SeaweedFS release tarball
      ansible.builtin.get_url:
        url: "{{ seaweedfs_download_url }}"
        dest: "/tmp/seaweedfs-{{ seaweedfs_version }}.tar.gz"
        mode: "0644"

    - name: Extract SeaweedFS (weed binary)
      ansible.builtin.unarchive:
        src: "/tmp/seaweedfs-{{ seaweedfs_version }}.tar.gz"
        dest: "{{ seaweedfs_install_dir }}"
        remote_src: true
        creates: "{{ seaweedfs_bin }}"

    - name: Symlink weed into /usr/local/bin
      ansible.builtin.file:
        src: "{{ seaweedfs_bin }}"
        dest: /usr/local/bin/weed
        state: link
        force: true

    - name: Ensure config directory exists
      ansible.builtin.file:
        path: "{{ seaweedfs_config_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Ensure data directories exist
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default(seaweedfs_user) }}"
        group: "{{ item.group | default(seaweedfs_group) }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ seaweedfs_master_dir }}", mode: "0750" }
        - { path: "{{ seaweedfs_filer_dir }}", mode: "0750" }
        - { path: "{{ seaweedfs_volume_nvme_dir }}", mode: "0750" }
        - { path: "{{ seaweedfs_volume_hdd_dir }}", mode: "0750" }
        - { path: "{{ seaweedfs_volume_index_dir }}", mode: "0750" }

    - name: Write security.toml
      ansible.builtin.template:
        src: security.toml.j2
        dest: "{{ seaweedfs_security_toml_path }}"
        owner: "{{ seaweedfs_user }}"
        group: "{{ seaweedfs_group }}"
        mode: "0600"
      notify: Restart all seaweedfs services

    - name: Write s3.json
      ansible.builtin.template:
        src: s3.json.j2
        dest: "{{ seaweedfs_s3_config_path }}"
        owner: "{{ seaweedfs_user }}"
        group: "{{ seaweedfs_group }}"
        mode: "0600"
      notify: Restart seaweedfs-s3

    - name: Write filer.toml
      ansible.builtin.template:
        src: filer.toml.j2
        dest: "{{ seaweedfs_config_dir }}/filer.toml"
        owner: "{{ seaweedfs_user }}"
        group: "{{ seaweedfs_group }}"
        mode: "0600"
      notify: Restart seaweedfs-filer

    - name: Install systemd service - master
      ansible.builtin.template:
        src: seaweedfs-master.service.j2
        dest: /etc/systemd/system/seaweedfs-master.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd daemon

    - name: Install systemd service - volume
      ansible.builtin.template:
        src: seaweedfs-volume.service.j2
        dest: /etc/systemd/system/seaweedfs-volume.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd daemon

    - name: Install systemd service - filer
      ansible.builtin.template:
        src: seaweedfs-filer.service.j2
        dest: /etc/systemd/system/seaweedfs-filer.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd daemon

    - name: Install systemd service - s3
      ansible.builtin.template:
        src: seaweedfs-s3.service.j2
        dest: /etc/systemd/system/seaweedfs-s3.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd daemon

    - name: Enable and start SeaweedFS services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
        daemon_reload: true
      loop:
        - seaweedfs-master.service
        - seaweedfs-volume.service
        - seaweedfs-filer.service
        - seaweedfs-s3.service

    - name: Wait for filer to be ready
      ansible.builtin.wait_for:
        host: "{{ seaweedfs_ip }}"
        port: "{{ seaweedfs_port_filer }}"
        timeout: 30

    - name: Configure nvme_ bucket prefix to use NVMe disk
      ansible.builtin.shell: |
        echo 'fs.configure -locationPrefix=/buckets/nvme_ -disk=nvme -apply' | \
        /usr/local/bin/weed shell -master={{ seaweedfs_ip }}:{{ seaweedfs_port_master }}
      register: fs_configure_result
      changed_when: "'nvme' in fs_configure_result.stdout"

  handlers:
    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart all seaweedfs services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
        daemon_reload: true
      loop:
        - seaweedfs-master.service
        - seaweedfs-volume.service
        - seaweedfs-filer.service
        - seaweedfs-s3.service

    - name: Restart seaweedfs-s3
      ansible.builtin.systemd:
        name: seaweedfs-s3.service
        state: restarted
        daemon_reload: true

    - name: Restart seaweedfs-filer
      ansible.builtin.systemd:
        name: seaweedfs-filer.service
        state: restarted
        daemon_reload: true
