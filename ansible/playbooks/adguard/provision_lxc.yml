---
# Provision AdGuard LXC using custom NixOS base image
# The base image has SSH CA trust baked in - no bootstrap needed!
#
# Prerequisites:
#   1. Build and upload the base image: task nix:upload-lxc-image
#   2. This creates /var/lib/vz/template/cache/nixos-base-lxc.tar.xz on oracle
#
# After provisioning:
#   task configure:adguard  # Deploys the full NixOS config via nixos-rebuild

- name: Provision AdGuard LXC (NixOS)
  hosts: oracle
  gather_facts: true
  roles:
    - common
  vars:
    # Custom NixOS base image with SSH CA trust baked in (on cephfs, shared across nodes)
    nixos_template: "cephfs:vztmpl/nixos-base-lxc.tar.xz"
    nixos_template_path: "/mnt/pve/cephfs/template/cache/nixos-base-lxc.tar.xz"
    lxc_id: "{{ vm.adguard.id }}"
  tasks:
    - name: Check if base image exists on cephfs
      stat:
        path: "{{ nixos_template_path }}"
      register: base_image
      delegate_to: smith

    - name: Fail if base image not found
      fail:
        msg: |
          NixOS base image not found at {{ nixos_template }}
          Build and upload it first: task nix:upload-lxc-image
      when: not base_image.stat.exists

    - name: Check if AdGuard LXC exists
      command: pct status {{ lxc_id }}
      register: lxc_exists
      failed_when: false
      changed_when: false

    - name: Stop AdGuard LXC
      command: pct stop {{ lxc_id }}
      when: lxc_exists.rc == 0
      register: stop_result
      failed_when: false
      changed_when: stop_result.rc == 0

    - name: Wait for LXC to stop
      command: pct status {{ lxc_id }}
      register: lxc_status
      until: "'stopped' in lxc_status.stdout"
      retries: 30
      delay: 2
      when: lxc_exists.rc == 0 and stop_result.rc == 0
      changed_when: false

    - name: Delete AdGuard LXC
      command: pct destroy {{ lxc_id }} --purge
      when: lxc_exists.rc == 0
      register: delete_result
      failed_when: false
      changed_when: delete_result.rc == 0

    - name: Create AdGuard LXC
      command: >
        pct create {{ lxc_id }}
        {{ nixos_template }}
        --hostname {{ vm.adguard.name }}
        --cores {{ vm.adguard.cores }}
        --memory {{ vm.adguard.memory }}
        --rootfs local-lvm:{{ vm.adguard.disk_gb }}
        --net0 name=eth0,bridge=vmbr0,gw={{ vm.adguard.gateway }},ip={{ vm.adguard.ip }}/24
        --nameserver {{ vm.router.ip.gigahub }}
        --features nesting=1
        --unprivileged 1
      changed_when: true

    - name: Start AdGuard LXC
      command: pct start {{ lxc_id }}
      changed_when: true

    - name: Wait for SSH to be ready
      wait_for:
        host: "{{ vm.adguard.ip }}"
        port: 22
        timeout: 120
      delegate_to: localhost
