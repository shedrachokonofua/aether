---
- name: Deploy ComfyUI
  hosts: gpu-workstation
  gather_facts: true
  roles:
    - common
  tasks:
    - name: Create storage directory
      file:
        path: ./comfyui/storage
        state: directory
        mode: "0755"

    - name: Create comfyui container
      containers.podman.podman_container:
        name: comfyui
        image: docker.io/yanwk/comfyui-boot:cu129-slim
        pull: always
        state: quadlet
        restart_policy: on-failure
        recreate: true
        ports:
          - "{{ vm.gpu_workstation.ports.comfyui }}:8188/tcp"
        volumes:
          - /home/aether/comfyui/storage:/root:Z
        device:
          - nvidia.com/gpu=all
        env:
          CLI_ARGS: "--use-pytorch-cross-attention --fast fp16_accumulation --normalvram --reserve-vram 1 --fp16-vae --cuda-malloc"
        security_opt:
          - label=disable
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target

    - name: Reload systemd daemon for user
      systemd:
        daemon_reload: yes
        scope: user

    - name: Start comfyui service
      systemd:
        name: comfyui
        state: restarted
        scope: user

    - name: Wait for comfyui to start
      wait_for:
        port: 8188
        host: 127.0.0.1
        timeout: 120
    - name: Wait for ComfyUI to create directory structure
      wait_for:
        path: "/home/aether/comfyui/storage/ComfyUI/models/checkpoints"
        state: present
        timeout: 30

    - name: Download QwenEditUtils custom nodes
      git:
        repo: "https://github.com/lrzjason/Comfyui-QwenEditUtils.git"
        dest: "/home/aether/comfyui/storage/ComfyUI/custom_nodes/Comfyui-QwenEditUtils"
        version: master
        update: yes

    - name: Check existing ComfyUI models
      stat:
        path: "/home/aether/comfyui/storage/ComfyUI/models/{{ item.type }}/{{ item.filename }}"
      loop:
        - url: "https://huggingface.co/cyberdelia/CyberRealisticPony/resolve/main/CyberRealisticPony_V13.0_FP16.safetensors"
          type: checkpoints
          filename: "CyberRealisticPony_V13.0_FP16.safetensors"
        - url: "https://huggingface.co/madebyollin/sdxl-vae-fp16-fix/resolve/main/sdxl_vae.safetensors"
          type: vae
          filename: "sdxl_vae.safetensors"
        - url: "https://huggingface.co/Comfy-Org/Qwen-Image-Edit_ComfyUI/resolve/main/split_files/diffusion_models/qwen_image_edit_fp8_e4m3fn.safetensors"
          type: diffusion_models
          filename: "qwen_image_edit_fp8_e4m3fn.safetensors"
        - url: "https://huggingface.co/lightx2v/Qwen-Image-Lightning/resolve/main/Qwen-Image-Lightning-4steps-V1.0.safetensors"
          type: loras
          filename: "Qwen-Image-Lightning-4steps-V1.0.safetensors"
        - url: "https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI/resolve/main/split_files/text_encoders/qwen_2.5_vl_7b_fp8_scaled.safetensors"
          type: text_encoders
          filename: "qwen_2.5_vl_7b_fp8_scaled.safetensors"
        - url: "https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI/resolve/main/split_files/vae/qwen_image_vae.safetensors"
          type: vae
          filename: "qwen_image_vae.safetensors"
        - url: "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/text_encoders/qwen_3_4b.safetensors"
          type: text_encoders
          filename: "qwen_3_4b.safetensors"
        - url: "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/diffusion_models/z_image_turbo_bf16.safetensors"
          type: diffusion_models
          filename: "z_image_turbo_bf16.safetensors"
        - url: "https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/vae/ae.safetensors"
          type: vae
          filename: "ae.safetensors"
      register: model_files

    - name: Download ComfyUI models
      get_url:
        url: "{{ item.item.url }}"
        dest: "/home/aether/comfyui/storage/ComfyUI/models/{{ item.item.type }}/{{ item.item.filename }}"
        mode: "0644"
        timeout: 300
      loop: "{{ model_files.results }}"
      when: not item.stat.exists
      register: model_download
      retries: 3
      delay: 10
      until: model_download is not failed
