---
- name: Deploy ClearML MLOps Platform
  hosts: gpu-workstation
  gather_facts: true
  roles:
    - common
    - docker
  tasks:
    - name: Create ClearML directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /home/aether/clearml
        - /home/aether/clearml/logs
        - /home/aether/clearml/config
        - /home/aether/clearml/agent-gpu
        - /home/aether/clearml/agent-gpu-build
        - /home/aether/clearml/agent-services
        - /home/aether/clearml/serving

    - name: Copy hosts config
      copy:
        src: hosts.conf
        dest: /home/aether/clearml/config/hosts.conf
        mode: "0644"

    - name: Set Docker socket permissions
      file:
        path: /var/run/docker.sock
        mode: "0666"
      become: true

    - name: Create ClearML pod
      containers.podman.podman_pod:
        name: clearml
        state: quadlet
        restart_policy: on-failure
        recreate: true
        ports:
          - "{{ vm.gpu_workstation.ports.clearml_web }}:80"
          - "{{ vm.gpu_workstation.ports.clearml_api }}:8008"
          - "{{ vm.gpu_workstation.ports.clearml_files }}:8081"
          - "{{ vm.gpu_workstation.ports.clearml_serving }}:8080"
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target

    - name: Create mongo db volume
      containers.podman.podman_volume:
        name: clearml_mongo_db
        state: quadlet

    - name: Create mongo configdb volume
      containers.podman.podman_volume:
        name: clearml_mongo_configdb
        state: quadlet

    - name: Create elastic volume
      containers.podman.podman_volume:
        name: clearml_elastic
        state: quadlet

    - name: Create redis volume
      containers.podman.podman_volume:
        name: clearml_redis
        state: quadlet

    - name: Create fileserver volume
      containers.podman.podman_volume:
        name: clearml_fileserver
        state: quadlet

    - name: Create MongoDB container
      containers.podman.podman_container:
        name: clearml-mongo
        image: docker.io/mongo:7.0
        state: quadlet
        pod: clearml.pod
        command:
          - --setParameter
          - internalQueryMaxBlockingSortMemoryUsageBytes=196100200
        volumes:
          - clearml_mongo_db.volume:/data/db:Z
          - clearml_mongo_configdb.volume:/data/configdb:Z

    - name: Create Elasticsearch container
      containers.podman.podman_container:
        name: clearml-elastic
        image: docker.io/elasticsearch:8.17.0
        state: quadlet
        pod: clearml.pod
        env:
          ES_JAVA_OPTS: "-Xms2g -Xmx2g -Dlog4j2.formatMsgNoLookups=true"
          bootstrap.memory_lock: "true"
          cluster.name: clearml
          cluster.routing.allocation.node_initial_primaries_recoveries: "500"
          cluster.routing.allocation.disk.watermark.low: 500mb
          cluster.routing.allocation.disk.watermark.high: 500mb
          cluster.routing.allocation.disk.watermark.flood_stage: 500mb
          discovery.type: single-node
          http.compression_level: "7"
          node.name: clearml
          xpack.security.enabled: "false"
        volumes:
          - clearml_elastic.volume:/usr/share/elasticsearch/data:Z
        ulimits:
          - memlock=-1:-1
          - nofile=65536:65536

    - name: Create Redis container
      containers.podman.podman_container:
        name: clearml-redis
        image: docker.io/redis:7.4
        state: quadlet
        pod: clearml.pod
        volumes:
          - clearml_redis.volume:/data:Z

    - name: Create ClearML File Server container
      containers.podman.podman_container:
        name: clearml-fileserver
        image: docker.io/clearml/server:latest
        state: quadlet
        pod: clearml.pod
        command: fileserver
        env:
          CLEARML__fileserver__delete__allow_batch: "true"
        volumes:
          - /home/aether/clearml/logs:/var/log/clearml:Z
          - clearml_fileserver.volume:/mnt/fileserver:Z
          - /home/aether/clearml/config:/opt/clearml/config:Z

    - name: Create ClearML API Server container
      containers.podman.podman_container:
        name: clearml-apiserver
        image: docker.io/clearml/server:latest
        state: quadlet
        pod: clearml.pod
        command: apiserver
        env:
          CLEARML_ELASTIC_SERVICE_HOST: "127.0.0.1"
          CLEARML_ELASTIC_SERVICE_PORT: "9200"
          CLEARML_MONGODB_SERVICE_HOST: "127.0.0.1"
          CLEARML_MONGODB_SERVICE_PORT: "27017"
          CLEARML_REDIS_SERVICE_HOST: "127.0.0.1"
          CLEARML_REDIS_SERVICE_PORT: "6379"
          CLEARML__apiserver__pre_populate__enabled: "true"
          CLEARML__apiserver__pre_populate__zip_files: "/opt/clearml/db-pre-populate"
          CLEARML__apiserver__pre_populate__artifacts_path: "/mnt/fileserver"
          CLEARML__apiserver__pre_populate__external_web_url: "https://clearml.home.shdr.ch"
          CLEARML__apiserver__pre_populate__external_api_url: "https://api.clearml.home.shdr.ch"
          CLEARML__apiserver__pre_populate__external_files_url: "https://files.clearml.home.shdr.ch"
          CLEARML__services__async_urls_delete__enabled: "true"
          CLEARML__services__async_urls_delete__fileserver__url_prefixes: "[http://127.0.0.1:8081]"
          CLEARML__secure__credentials__services_agent__user_key: "{{ secrets.clearml.api_access_key }}"
          CLEARML__secure__credentials__services_agent__user_secret: "{{ secrets.clearml.api_secret_key }}"
        volumes:
          - /home/aether/clearml/logs:/var/log/clearml:Z
          - /home/aether/clearml/config:/opt/clearml/config:Z
          - clearml_fileserver.volume:/mnt/fileserver:Z

    - name: Create ClearML Web Server container
      containers.podman.podman_container:
        name: clearml-webserver
        image: docker.io/clearml/server:latest
        state: quadlet
        pod: clearml.pod
        command: webserver

    - name: Create ClearML async delete container
      containers.podman.podman_container:
        name: clearml-async-delete
        image: docker.io/clearml/server:latest
        state: quadlet
        pod: clearml.pod
        env:
          CLEARML_ELASTIC_SERVICE_HOST: "127.0.0.1"
          CLEARML_ELASTIC_SERVICE_PORT: "9200"
          CLEARML_MONGODB_SERVICE_HOST: "127.0.0.1"
          CLEARML_MONGODB_SERVICE_PORT: "27017"
          CLEARML_REDIS_SERVICE_HOST: "127.0.0.1"
          CLEARML_REDIS_SERVICE_PORT: "6379"
          PYTHONPATH: "/opt/clearml/apiserver"
          CLEARML__services__async_urls_delete__fileserver__url_prefixes: "[http://127.0.0.1:8081]"
        command:
          - python3
          - -m
          - jobs.async_urls_delete
          - --fileserver-host
          - http://127.0.0.1:8081
        volumes:
          - /home/aether/clearml/logs:/var/log/clearml:Z
          - /home/aether/clearml/config:/opt/clearml/config:Z

    - name: Remove old ClearML Agent container
      containers.podman.podman_container:
        name: clearml-agent
        state: absent
      ignore_errors: true

    - name: Remove old ClearML Agent quadlet
      file:
        path: ~/.config/containers/systemd/clearml-agent.container
        state: absent

    - name: Remove old shared agent directory
      file:
        path: /home/aether/clearml/agent
        state: absent

    - name: Create ClearML Services Agent container
      containers.podman.podman_container:
        name: clearml-agent-services
        image: docker.io/clearml/clearml-agent-services:latest
        pull: always
        state: quadlet
        pod: clearml.pod
        env:
          CLEARML_WEB_HOST: "http://127.0.0.1:80"
          CLEARML_API_HOST: "http://127.0.0.1:8008"
          CLEARML_FILES_HOST: "http://127.0.0.1:8081"
          CLEARML_API_ACCESS_KEY: "{{ secrets.clearml.api_access_key }}"
          CLEARML_API_SECRET_KEY: "{{ secrets.clearml.api_secret_key }}"
          CLEARML_WORKER_ID: "gpu-workstation-services"
          CLEARML_AGENT_DOCKER_HOST_MOUNT: "/home/aether/clearml/agent-services:/root/.clearml"
        volumes:
          - /home/aether/clearml/agent-services:/root/.clearml:Z
          - /var/run/docker.sock:/var/run/docker.sock
        security_opt:
          - label=disable
        quadlet_options:
          - |
            [Unit]
            After=clearml-apiserver.service

    - name: Copy GPU Agent Dockerfile
      copy:
        src: gpu-agent/Dockerfile
        dest: /home/aether/clearml/agent-gpu-build/Dockerfile
        mode: "0644"

    - name: Copy GPU Agent entrypoint
      copy:
        src: gpu-agent/entrypoint.sh
        dest: /home/aether/clearml/agent-gpu-build/entrypoint.sh
        mode: "0755"

    - name: Create GPU agent config
      template:
        src: gpu-agent/clearml-agent.conf.j2
        dest: /home/aether/clearml/agent-gpu/clearml.conf
        mode: "0644"

    - name: Build ClearML GPU Agent image
      containers.podman.podman_image:
        name: clearml-agent-gpu
        path: /home/aether/clearml/agent-gpu-build
        build:
          rm: true
        state: build
        force: true

    - name: Create ClearML GPU Agent container
      containers.podman.podman_container:
        name: clearml-agent-gpu
        image: localhost/clearml-agent-gpu:latest
        state: quadlet
        pod: clearml.pod
        env:
          CLEARML_AGENT_DEFAULT_BASE_DOCKER: "nvidia/cuda:12.9.0-runtime-ubuntu24.04"
          CLEARML_AGENT_QUEUES: "default"
        volumes:
          - /home/aether/clearml/agent-gpu:/root/.clearml:Z
          - /var/run/docker.sock:/var/run/docker.sock
        security_opt:
          - label=disable
        quadlet_options:
          - |
            [Unit]
            After=clearml-apiserver.service

    - name: Create ClearML Serving container
      containers.podman.podman_container:
        name: clearml-serving
        image: docker.io/allegroai/clearml-serving-inference:latest
        pull: always
        state: quadlet
        pod: clearml.pod
        restart_policy: "no"
        device:
          - nvidia.com/gpu=all
        env:
          CLEARML_WEB_HOST: "http://127.0.0.1:80"
          CLEARML_API_HOST: "http://127.0.0.1:8008"
          CLEARML_FILES_HOST: "http://127.0.0.1:8081"
          CLEARML_API_ACCESS_KEY: "{{ secrets.clearml.api_access_key }}"
          CLEARML_API_SECRET_KEY: "{{ secrets.clearml.api_secret_key }}"
          CLEARML_SERVING_PORT: "8080"
          CLEARML_SERVING_POLL_FREQ: "1.0"
        volumes:
          - /home/aether/clearml/serving:/opt/clearml/serving:Z
        security_opt:
          - label=disable

    - name: Reload systemd
      systemd:
        daemon_reload: yes
        scope: user

    - name: Start ClearML pod
      systemd:
        name: clearml-pod
        state: restarted
        scope: user

    - name: Wait for ClearML to be ready
      wait_for:
        host: localhost
        port: "{{ vm.gpu_workstation.ports.clearml_web }}"
        timeout: 120
      register: wait_result
      until: not wait_result.failed
      retries: 5
      delay: 10
