---
- name: Deploy UPS Management Stack
  hosts: ups-management-stack
  gather_facts: true
  roles:
    - common
    - vm_baseline
    - dnf
    - role: vm_monitoring_agent
      prometheus_scrape_configs:
        - job_name: "nut_exporter"
          scrape_interval: "30s"
          metrics_path: "/ups_metrics"
          params:
            ups: ["ups"]
          static_configs:
            - targets:
                ["localhost:{{ vm.ups_management_stack.ports.nut_exporter }}"]
  tasks:
    - name: Ensure NUT directory exists with correct permissions
      file:
        path: /home/aether/nut
        state: directory
        mode: "0755"
        owner: aether
        group: aether
      become: true

    - name: Create subdirectories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /home/aether/nut/run
        - /home/aether/peanut/config

    - name: Configure PeaNUT settings
      template:
        src: ./settings.yml.j2
        dest: /home/aether/peanut/config/settings.yml
        mode: "0644"

    - name: Configure NUT for SNMPv3
      template:
        src: ./ups.conf.j2
        dest: /home/aether/nut/ups.conf
        mode: "0644"

    - name: Configure NUT server
      template:
        src: ./upsd.conf.j2
        dest: /home/aether/nut/upsd.conf
        mode: "0644"

    - name: Configure NUT users
      template:
        src: ./upsd.users.j2
        dest: /home/aether/nut/upsd.users
        mode: "0644"

    - name: Configure NUT mode
      copy:
        content: "MODE=netserver\n"
        dest: /home/aether/nut/nut.conf
        mode: "0644"

    - name: Create the UPS Management pod using quadlet
      containers.podman.podman_pod:
        name: ups-management-stack
        ports:
          - "{{ vm.ups_management_stack.ports.peanut }}:8080"
          - "{{ vm.ups_management_stack.ports.nut_server }}:3493"
          - "{{ vm.ups_management_stack.ports.nut_exporter }}:9199"
        state: quadlet
        restart_policy: on-failure
        recreate: true
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target

    - name: Start NUT server container
      containers.podman.podman_container:
        name: nut-server
        image: ghcr.io/tigattack/nut-upsd:latest
        pod: ups-management-stack.pod
        volumes:
          - /home/aether/nut:/etc/nut:Z,U
          - /home/aether/nut/run:/var/run/nut:Z,U
        user: "100:100"
        state: quadlet

    - name: Start PeaNUT container
      containers.podman.podman_container:
        name: peanut
        image: docker.io/brandawg93/peanut:latest
        pod: ups-management-stack.pod
        volumes:
          - /home/aether/peanut/config:/config:Z,U
        state: quadlet
        env:
          WEB_PORT: "8080"

    - name: Start NUT Exporter container
      containers.podman.podman_container:
        name: nut-exporter
        image: ghcr.io/druggeri/nut_exporter:latest
        pod: ups-management-stack.pod
        state: quadlet
        env:
          NUT_EXPORTER_SERVER: "localhost"
          NUT_EXPORTER_SERVERPORT: "3493"
          NUT_EXPORTER_USERNAME: "{{ secrets.ups.nut_username }}"
          NUT_EXPORTER_PASSWORD: "{{ secrets.ups.nut_password }}"
          NUT_EXPORTER_VARIABLES: ""

    - name: Reload systemd user configuration
      systemd:
        daemon_reload: yes
        scope: user

    - name: Ensure ups-management-stack pod service is started
      systemd:
        name: ups-management-stack-pod.service
        state: restarted
        enabled: yes
        scope: user
