---
- name: Deploy tailscale subnet router pod
  hosts: home-gateway-stack
  gather_facts: true
  roles:
    - common
  tasks:
    - name: Ensure ip forwarding is enabled
      ansible.builtin.sysctl:
        name: "{{ item }}"
        value: 1
        state: present
      become: true
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - ./tailscale/data

    - name: Create tailscale pod
      containers.podman.podman_pod:
        name: tailscale
        state: quadlet
        network: host
        restart_policy: on-failure
        recreate: true
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target

    - name: Create Tailscale access token
      uri:
        url: https://api.tailscale.com/api/v2/oauth/token
        method: POST
        body_format: form-urlencoded
        body:
          client_id: "{{ secrets.tailscale_oauth_client_id }}"
          client_secret: "{{ secrets.tailscale_oauth_client_secret }}"
      register: tailscale_oauth_response

    - name: Extract Tailscale access token
      ansible.builtin.set_fact:
        tailscale_access_token: "{{ (tailscale_oauth_response.json | default({})).access_token | mandatory('Access token not found') }}"

    - name: Create Tailscale auth key
      uri:
        url: https://api.tailscale.com/api/v2/tailnet/{{ secrets.tailscale_tailnet_name }}/keys?all=true
        method: POST
        headers:
          Authorization: "Bearer {{ tailscale_access_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          description: "Tailscale auth key for gateway stack"
          capabilities:
            devices:
              create:
                ephemeral: false
                reusable: false
                preauthorized: true
                tags:
                  - tag:aether
          expirySeconds: 900
      register: tailscale_keys_response

    - name: Extract Tailscale auth key
      ansible.builtin.set_fact:
        tailscale_auth_key: "{{ (tailscale_keys_response.json | default({})).key | mandatory('Auth key not found') }}"

    - name: Create tailscale container
      containers.podman.podman_container:
        name: tailscale
        image: docker.io/tailscale/tailscale:latest
        state: quadlet
        pod: tailscale.pod
        cap_add:
          - NET_ADMIN
          - NET_RAW
        env:
          TS_AUTHKEY: "{{ tailscale_auth_key }}"
          TS_ROUTES: "10.0.0.0/8,192.168.0.0/16"
          TS_ACCEPT_DNS: "false"
          TS_HOSTNAME: "aether-home-gateway"
        volumes:
          - /home/aether/tailscale/data:/var/lib/tailscale:Z
          - /dev/net/tun:/dev/net/tun
        security_opt:
          - label=disable

    - name: Reload systemd daemon for user
      ansible.builtin.systemd:
        daemon_reload: yes
        scope: user

    - name: Start tailscale quadlet
      ansible.builtin.systemd:
        name: tailscale-pod
        state: restarted
        scope: user
