---
- name: Deploy tailscale subnet router (rootful)
  hosts: home-gateway-stack
  gather_facts: true
  roles:
    - common
  tasks:
    - name: Ensure ip forwarding is enabled
      ansible.builtin.sysctl:
        name: "{{ item }}"
        value: 1
        state: present
      become: true
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    - name: Create state directory
      file:
        path: /var/lib/tailscale
        state: directory
        mode: "0700"
      become: true

    - name: Migrate state from old rootless container
      ansible.builtin.copy:
        src: /home/aether/tailscale/data/
        dest: /var/lib/tailscale/
        remote_src: true
        mode: preserve
      become: true
      ignore_errors: true

    - name: Stop old rootless tailscale pod
      ansible.builtin.systemd:
        name: tailscale-pod
        state: stopped
        scope: user
      ignore_errors: true

    - name: Remove old rootless quadlet files
      ansible.builtin.file:
        path: "/home/aether/.config/containers/systemd/{{ item }}"
        state: absent
      loop:
        - tailscale.container
        - tailscale.pod

    - name: Reload user systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes
        scope: user

    - name: Create tailscale pod (rootful)
      containers.podman.podman_pod:
        name: tailscale
        state: quadlet
        network: host
        restart_policy: on-failure
        recreate: true
        quadlet_options:
          - |
            [Install]
            WantedBy=multi-user.target
      become: true

    - name: Create tailscale container (rootful)
      containers.podman.podman_container:
        name: tailscale
        image: docker.io/tailscale/tailscale:latest
        state: quadlet
        pod: tailscale.pod
        cap_add:
          - NET_ADMIN
          - NET_RAW
        env:
          TS_AUTHKEY: "{{ secrets.tailscale_oauth_client_secret }}?ephemeral=false"
          TS_USERSPACE: "false"
          TS_ROUTES: "10.0.0.0/8,192.168.0.0/16"
          TS_ACCEPT_DNS: "false"
          TS_HOSTNAME: "aether-home-gateway"
          TS_EXTRA_ARGS: "--advertise-tags=tag:home-gateway"
          TS_STATE_DIR: "/var/lib/tailscale"
        volumes:
          - /var/lib/tailscale:/var/lib/tailscale:Z
          - /dev/net/tun:/dev/net/tun
        security_opt:
          - label=disable
      become: true

    - name: Create GitLab SSH forward container (rootful)
      containers.podman.podman_container:
        name: gitlab-ssh-forward
        image: docker.io/alpine/socat:latest
        state: quadlet
        network: host
        command: "TCP-LISTEN:2222,bind={{ tf_outputs.home_gateway_tailscale_ip.value }},fork,reuseaddr TCP:{{ vm.gitlab.ip }}:2222"
        quadlet_options:
          - |
            [Unit]
            After=tailscale-pod.service

            [Install]
            WantedBy=multi-user.target
      become: true

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes
        scope: system
      become: true

    - name: Start tailscale quadlet
      ansible.builtin.systemd:
        name: tailscale-pod
        state: restarted
        scope: system
      become: true

    - name: Start GitLab SSH forward
      ansible.builtin.systemd:
        name: gitlab-ssh-forward
        state: restarted
        scope: system
      become: true
