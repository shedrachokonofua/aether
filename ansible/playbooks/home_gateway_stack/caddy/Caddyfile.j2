{
  debug
  metrics {
    per_host
  }
  acme_dns cloudflare {{ secrets.cloudflare_dns_api_key }}
  admin :2019 {
    origins caddy.home.shdr.ch
  }
}

home.shdr.ch {
  respond "Welcome home"
}

caddy.home.shdr.ch {
  reverse_proxy localhost:2019 {
    header_up Host localhost
  }
}

niobe.home.shdr.ch {
  reverse_proxy 192.168.2.201:8006 {
    transport http {
      tls
      tls_insecure_skip_verify
    }
    header_up Host {http.request.host}
    header_up X-Real-IP {http.request.remote}
    header_up X-Forwarded-For {http.request.remote}
    header_up Upgrade {http.request.header.Upgrade}
    header_up Connection {http.request.header.Connection}
  }
}

rack-switch.home.shdr.ch {
  reverse_proxy 192.168.2.221
}

office-switch.home.shdr.ch {
  reverse_proxy 192.168.2.222 {
    transport http {
      versions 1.1
      keepalive off
    }
    # Remove all headers and add back only what's needed
    header_up -*
    header_up Host 192.168.2.222
    header_up Authorization {http.request.header.Authorization}
    header_up Connection "close"
    # No buffering for CGI
    flush_interval -1
  }
}

dns.home.shdr.ch {
  reverse_proxy {{ vm.adguard.ip }}:{{ vm.adguard.ports.admin }}
}

ap.home.shdr.ch {
  reverse_proxy https://{{ vm.home_gateway_stack.ip }}:{{ vm.home_gateway_stack.ports.unifi_admin }} {
    transport http {
      tls
      tls_insecure_skip_verify
    }
    header_up Host {http.request.host}
    header_up X-Real-IP {http.request.remote}
    header_up X-Forwarded-For {http.request.remote}
    header_up Upgrade {http.request.header.Upgrade}
    header_up Connection {http.request.header.Connection}
  }
}

grafana.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.grafana }}
}


otel.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.otel_http }}
}

otel-grpc.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.otel_grpc }}
}

otel-metrics.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.otel_metrics }}
}

otel-prometheus.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.otel_prometheus }}
}

prometheus.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.prometheus }}
}

loki.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.loki }}
}

clickhouse.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.clickhouse }}
}

wazuh.home.shdr.ch {
  reverse_proxy https://{{ vm.ids_stack.ip }}:{{ vm.ids_stack.ports.wazuh_api }} {
    transport http {
      tls
      tls_insecure_skip_verify
    }
  }
}

hids.home.shdr.ch {
  reverse_proxy https://{{ vm.ids_stack.ip }}:{{ vm.ids_stack.ports.wazuh_dashboard }} {
    transport http {
      tls
      tls_insecure_skip_verify
    }
  }
}

kvm.home.shdr.ch {
  reverse_proxy 192.168.2.220
}

d.home.shdr.ch, *.d.home.shdr.ch {
  reverse_proxy {{ vm.dokploy.ip }}
}

traefik.d.home.shdr.ch {
  reverse_proxy {{ vm.dokploy.ip }}:{{ vm.dokploy.ports.traefik }}
}

watchtower.d.home.shdr.ch {
  reverse_proxy {{ vm.dokploy.ip }}:{{ vm.dokploy.ports.watchtower }}
}

gitlab.home.shdr.ch {
  reverse_proxy {{ vm.gitlab.ip }}
}

registry.gitlab.home.shdr.ch {
  reverse_proxy {{ vm.gitlab.ip }}:{{ vm.gitlab.ports.gitlab_registry }}
}

pages.gitlab.home.shdr.ch {
  reverse_proxy {{ vm.gitlab.ip }}:{{ vm.gitlab.ports.gitlab_pages }}
}

ha.home.shdr.ch {
  reverse_proxy {{ vm.iot_management_stack.ip }}:{{ vm.iot_management_stack.ports.home_assistant }}
}

z.ha.home.shdr.ch {
  reverse_proxy {{ vm.iot_management_stack.ip }}:{{ vm.iot_management_stack.ports.zwavejs }}
}

sunshine.game.home.shdr.ch {
  reverse_proxy {{ vm.game_server.ip }}:{{ vm.game_server.ports.sunshine }} {
    transport http {
      tls_insecure_skip_verify
    }
  }
}

cockpit.home.shdr.ch {
  reverse_proxy {{ vm.cockpit.ip }}:{{ vm.cockpit.ports.cockpit }} {
    transport http {
      tls_insecure_skip_verify
    }
  }
}

element.home.shdr.ch {
  reverse_proxy {{ vm.messaging_stack.ip }}:{{ vm.messaging_stack.ports.element }}
}

matrix.home.shdr.ch {
  reverse_proxy /_matrix/* {{ vm.messaging_stack.ip }}:{{ vm.messaging_stack.ports.synapse }}
  reverse_proxy /_synapse/client/* {{ vm.messaging_stack.ip }}:{{ vm.messaging_stack.ports.synapse }}
}

ntfy.home.shdr.ch {
  reverse_proxy {{ vm.messaging_stack.ip }}:{{ vm.messaging_stack.ports.ntfy }}
}

apprise.home.shdr.ch {
  reverse_proxy {{ vm.messaging_stack.ip }}:{{ vm.messaging_stack.ports.apprise }}
}

ollama.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.ollama }}
}

comfyui.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.comfyui }}
}

docling.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.docling }}
}

jupyter.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.jupyter }}
}

swarmui.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.swarmui }}
}

clearml.home.shdr.ch {
  handle /api/* {
    uri strip_prefix /api
    reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.clearml_api }}
  }
  handle {
    reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.clearml_web }}
  }
}

api.clearml.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.clearml_api }}
}

files.clearml.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.clearml_files }}
}

serving.clearml.home.shdr.ch {
  reverse_proxy {{ vm.gpu_workstation.ip }}:{{ vm.gpu_workstation.ports.clearml_serving }}
}

litellm.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.litellm }}
}

openwebui.home.shdr.ch {
  reverse_proxy 10.0.3.19 {
    header_up Host openwebui.apps.home.shdr.ch
    header_up X-Real-IP {http.request.remote}
    header_up X-Forwarded-For {http.request.remote}
    header_up X-Forwarded-Proto https
  }
}

mcpo.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.mcpo }}
}

searxng.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.searxng }}
}

firecrawl.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.firecrawl }}
}

mcp.firecrawl.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.firecrawl_mcp }}
}

bytebot.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.bytebot_ui }}
}

desktop.bytebot.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.bytebot_desktop }}
}

agent.bytebot.home.shdr.ch {
  reverse_proxy {{ vm.ai_tool_stack.ip }}:{{ vm.ai_tool_stack.ports.bytebot_agent }}
}

ups.home.shdr.ch {
  reverse_proxy 192.168.2.223 {
    transport http {
      versions 1.1
      keepalive off
    }
    # Keep the original host header
    header_up Host {http.request.host}
    header_up X-Real-IP {http.request.remote}
    header_up X-Forwarded-For {http.request.remote}
    header_up X-Forwarded-Proto {http.request.scheme}
    header_up X-Forwarded-Host {http.request.host}
    # Preserve cookies and auth
    header_up Cookie {http.request.header.Cookie}
    header_up Authorization {http.request.header.Authorization}
    # No buffering for real-time updates
    flush_interval -1
  }
}

peanut.home.shdr.ch {
  reverse_proxy {{ vm.ups_management_stack.ip }}:{{ vm.ups_management_stack.ports.peanut }}
}

qbittorrent.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.qbittorrent }}
}

prowlarr.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.prowlarr }}
}

sabnzbd.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.sabnzbd }}
}

files.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.filestash }}
}

jellyfin.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.jellyfin }}
}

jellyseerr.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.jellyseerr }}
}

sonarr.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.sonarr }}
}

radarr.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.radarr }}
}

lidarr.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.lidarr }}
}

aiostreams.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.aiostreams }}
}

stremthru.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.stremthru }}
}

nzbdav.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.nzbdav }}
}

tuliprox.home.shdr.ch {
  reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.tuliprox }} {
    flush_interval -1
    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-For {remote_host}
  }
}

stats.proxy.home.shdr.ch {
  reverse_proxy localhost:{{ vm.home_gateway_stack.ports.rotating_proxy_metrics }}
}

kk.home.shdr.ch, *.kk.home.shdr.ch {
  reverse_proxy {{ vm.dokku.ip }}:{{ vm.dokku.ports.http }}
}

infisical.home.shdr.ch {
  reverse_proxy {{ vm.dokku.ip }}:{{ vm.dokku.ports.infisical }}
}

temporal.home.shdr.ch {
  reverse_proxy {{ vm.dokku.ip }}:{{ vm.dokku.ports.temporal_ui }}
}

grpc.temporal.home.shdr.ch {
  reverse_proxy {{ vm.dokku.ip }}:{{ vm.dokku.ports.temporal_grpc }} {
    transport http {
      versions h2c
    }
  }
}

auth.shdr.ch {
  reverse_proxy {{ vm.keycloak.ip }}:{{ vm.keycloak.ports.http }}
}

bao.home.shdr.ch {
  reverse_proxy {{ vm.openbao.ip }}:{{ vm.openbao.ports.https }} {
    transport http {
      tls
      tls_insecure_skip_verify
    }
    header_up Host {http.request.host}
    header_up X-Real-IP {http.request.remote}
    header_up X-Forwarded-For {http.request.remote}
    header_up Upgrade {http.request.header.Upgrade}
    header_up Connection {http.request.header.Connection}
  }
}

backrest.home.shdr.ch {
  reverse_proxy {{ vm.backup_stack.ip }}:{{ vm.backup_stack.ports.backrest }}
}

small.home.shdr.ch, *.small.home.shdr.ch {
  reverse_proxy {{ vm.smallweb.ip }}:{{ vm.smallweb.ports.http }}
}

fleet.home.shdr.ch {
  reverse_proxy {{ vm.monitoring_stack.ip }}:{{ vm.monitoring_stack.ports.fleet }}
}

openclaw.home.shdr.ch {
  # oauth2-proxy auth endpoints
  @oauth2 path /oauth2/*
  handle @oauth2 {
    reverse_proxy localhost:{{ vm.home_gateway_stack.ports.oauth2_proxy }}
  }

  # Protected â€” forward_auth checks Keycloak session
  handle {
    forward_auth localhost:{{ vm.home_gateway_stack.ports.oauth2_proxy }} {
      uri /oauth2/auth
      header_up X-Real-IP {http.request.remote}
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-Uri {uri}
      copy_headers X-Auth-Request-User X-Auth-Request-Email X-Auth-Request-Access-Token
    }
    reverse_proxy {{ vm.openclaw.ip }}:{{ vm.openclaw.ports.gateway }} {
      header_up Host {http.request.host}
      header_up X-Real-IP {http.request.remote}
      header_up X-Forwarded-For {http.request.remote}
      header_up Upgrade {http.request.header.Upgrade}
      header_up Connection {http.request.header.Connection}
    }
  }
}

# =============================================================================
# Ceph RGW (S3-compatible object storage)
# =============================================================================
# Load balances across RGW instances on Proxmox nodes

s3.home.shdr.ch {
  reverse_proxy 192.168.2.202:7480 192.168.2.204:7480 192.168.2.205:7480 {
    lb_policy round_robin
    health_uri /
    health_interval 10s
  }
}

# =============================================================================
# Kubernetes Cluster (Talos + Cilium)
# =============================================================================
# Expose Kubernetes OIDC discovery + JWKS (for RGW STS validation)
oidc.k8s.home.shdr.ch {
  @oidc path /.well-known/openid-configuration /openid/v1/jwks

  handle @oidc {
    reverse_proxy https://10.0.3.20:6443 {
      transport http {
        tls_insecure_skip_verify
      }
    }
  }

  handle {
    respond "Not Found" 404
  }
}

# Routes to Cilium L2 VIP (10.0.3.19) - Gateway API handles routing inside k8s

*.apps.home.shdr.ch {
  reverse_proxy 10.0.3.19 {
    header_up Host {http.request.host}
    header_up X-Real-IP {http.request.remote}
    header_up X-Forwarded-For {http.request.remote}
    header_up X-Forwarded-Proto {http.request.scheme}
  }
}

:9443 {
  @shdrch host shdr.ch
  @auth host auth.shdr.ch
  @ai host ai.shdr.ch
  @tv host tv.shdr.ch

  handle @shdrch {
    reverse_proxy {{ vm.dokku.ip }}:{{ vm.dokku.ports.http }} {
      header_up Host "shdrch.kk.home.shdr.ch"
      header_up X-Real-IP {http.request.header.X-Real-IP}
      header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
      header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
    }
  }

  handle @auth {
    # Block admin console and master realm from public internet
    @admin_paths path /admin/* /realms/master/*
    respond @admin_paths "Not Found" 404

    # Allow public OIDC endpoints
    reverse_proxy {{ vm.keycloak.ip }}:{{ vm.keycloak.ports.http }}
  }

  handle @ai {
    reverse_proxy 10.0.3.19 {
      header_up Host openwebui.apps.home.shdr.ch
      header_up X-Real-IP {http.request.header.X-Real-IP}
      header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
      header_up X-Forwarded-Host {http.request.host}
      header_up X-Forwarded-Proto https
    }
  }

  handle @tv {
    reverse_proxy {{ vm.media_stack.ip }}:{{ vm.media_stack.ports.jellyfin }}
  }

  @pdf host pdf.shdr.ch
  handle @pdf {
    # oauth2-proxy auth endpoints (callback, sign_in, sign_out)
    @oauth2 path /oauth2/*
    handle @oauth2 {
      reverse_proxy localhost:{{ vm.home_gateway_stack.ports.oauth2_proxy }}
    }

    # Protected content - forward_auth checks authentication
    handle {
      forward_auth localhost:{{ vm.home_gateway_stack.ports.oauth2_proxy }} {
        uri /oauth2/auth
        header_up X-Real-IP {http.request.header.X-Real-IP}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Uri {uri}
        copy_headers X-Auth-Request-User X-Auth-Request-Email X-Auth-Request-Access-Token
      }
      reverse_proxy {{ vm.dokploy.ip }} {
        header_up Host "bentopdf.d.home.shdr.ch"
        header_up X-Real-IP {http.request.header.X-Real-IP}
        header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
        header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
      }
    }
  }

  handle {
    respond "Not Found" 404
  }
}
