---
- name: Deploy caddy pod
  hosts: home-gateway-stack
  gather_facts: true
  roles:
    - common
  tasks:
    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - ./caddy/conf
        - ./caddy/data
        - ./caddy/config

    - name: Copy Caddyfile
      template:
        src: ./Caddyfile.j2
        dest: ./caddy/conf/Caddyfile
        mode: "0755"

    - name: Copy dockerfile
      copy:
        src: Dockerfile
        dest: ./caddy/Dockerfile
        mode: "0755"

    - name: Create caddy pod
      containers.podman.podman_pod:
        name: caddy
        state: quadlet
        network: host
        restart_policy: on-failure
        recreate: true
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target

    - name: Create caddy image
      containers.podman.podman_image:
        name: aether-caddy
        path: ./caddy
        state: present

    - name: Create caddy container
      containers.podman.podman_container:
        name: caddy
        image: aether-caddy
        state: quadlet
        pod: caddy.pod
        cap_add:
          - NET_ADMIN
        volumes:
          - /home/aether/caddy/conf:/etc/caddy:Z
          - /home/aether/caddy/data:/data:Z
          - /home/aether/caddy/config:/config:Z

    # oauth2-proxy for protecting apps without built-in auth (e.g. BentoPDF)
    - name: Create oauth2-proxy container
      containers.podman.podman_container:
        name: oauth2-proxy
        image: quay.io/oauth2-proxy/oauth2-proxy:latest
        state: quadlet
        pod: caddy.pod
        env:
          OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:{{ vm.home_gateway_stack.ports.oauth2_proxy }}"
          OAUTH2_PROXY_PROVIDER: "keycloak-oidc"
          OAUTH2_PROXY_OIDC_ISSUER_URL: "https://auth.shdr.ch/realms/aether"
          OAUTH2_PROXY_CLIENT_ID: "oauth2-proxy"
          OAUTH2_PROXY_CLIENT_SECRET: "{{ tf_outputs.keycloak_oauth2_proxy_client_secret.value }}"
          OAUTH2_PROXY_COOKIE_SECRET: "{{ secrets.oauth2_proxy.cookie_secret }}"
          OAUTH2_PROXY_COOKIE_SECURE: "true"
          OAUTH2_PROXY_COOKIE_DOMAINS: ".shdr.ch"
          OAUTH2_PROXY_WHITELIST_DOMAINS: ".shdr.ch"
          OAUTH2_PROXY_EMAIL_DOMAINS: "*"
          OAUTH2_PROXY_REVERSE_PROXY: "true"
          OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
          OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
          OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
        quadlet_options:
          - |
            [Unit]
            After=caddy.service

    - name: Reload systemd
      systemd:
        daemon_reload: yes
        scope: user

    - name: Start caddy quadlets
      systemd:
        name: caddy-pod
        state: restarted
        scope: user
