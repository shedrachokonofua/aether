---
- name: Configure NFS server
  hosts: nfs
  vars:
    nfs_exports:
      # HDD data for VMs (media, archive, etc.)
      - path: /mnt/hdd/data
        options: "rw,sync,no_subtree_check,no_root_squash"
        allowed_ips:
          - "10.0.2.0/24"
          - "10.0.3.0/24"
          - "10.0.4.0/24"
      # Blockchain data for Bitcoin/Monero nodes
      - path: /mnt/hdd/blockchain
        options: "rw,sync,no_subtree_check,no_root_squash"
        allowed_ips:
          - "10.0.2.0/24"
          - "10.0.3.0/24"
  roles:
    - common
    # - dnf
    # - vm_baseline
  tasks:
    - name: Install required packages
      dnf:
        name:
          - nfs-utils
          - kernel-modules-extra
        state: present

    - name: Ensure data directories exist
      file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
        owner: root
        group: root
      loop:
        - { path: /mnt/hdd/data/ml, mode: "0777" }

    - name: Ensure /var/lib/nfs directory exists with correct permissions
      file:
        path: /var/lib/nfs
        state: directory
        mode: "0755"
        owner: root
        group: root

    - name: Ensure required NFS state files exist
      file:
        path: "{{ item }}"
        state: touch
        mode: "0644"
        owner: root
        group: root
      with_items:
        - /var/lib/nfs/etab
        - /var/lib/nfs/rmtab

    - name: Ensure rpcbind service is enabled and started
      systemd:
        name: rpcbind
        enabled: yes
        state: started

    - name: Ensure nfs-server service is enabled and started
      systemd:
        name: nfs-server
        enabled: yes
        state: started

    - name: Write exports file
      copy:
        content: |
          {% for export in nfs_exports %}
          {{ export.path }} {% for ip in export.allowed_ips %}{{ ip }}({{ export.options }}) {% endfor %}

          {% endfor %}
        dest: /etc/exports

    - name: Refresh NFS exports
      command: exportfs -r
