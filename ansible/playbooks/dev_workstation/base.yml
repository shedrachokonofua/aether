---
- name: Base Dev Workstation setup
  hosts: dev-workstation
  gather_facts: true
  roles:
    - common
    - dnf
    - linger
    - monitoring_agent
    - docker
  tasks:
    - name: Write private key to file
      copy:
        content: "{{ tf_outputs.home_dev_workstation_private_key.value }}"
        dest: "/home/{{ vm.dev_workstation.admin }}/.ssh/id_ed25519"
        mode: "0600"
        owner: "{{ vm.dev_workstation.admin }}"
        group: "{{ vm.dev_workstation.admin }}"

    - name: Write public key to file
      copy:
        content: "{{ tf_outputs.home_dev_workstation_public_key.value }}"
        dest: "/home/{{ vm.dev_workstation.admin }}/.ssh/id_ed25519.pub"
        mode: "0644"
        owner: "{{ vm.dev_workstation.admin }}"
        group: "{{ vm.dev_workstation.admin }}"

    - name: Ensure ssh service is running
      systemd:
        name: sshd
        state: started
        enabled: true

    - name: Install required packages
      become: true
      dnf:
        name:
          - gcc
          - openssl-devel
          - protobuf-compiler
          - git
          - go-task
          - jq
          - lsof
          - unzip
        state: present

    - name: Configure git user
      command: git config --global user.name "{{ secrets.dev_workstation_git_user }}"

    - name: Configure git email
      command: git config --global user.email "{{ secrets.dev_workstation_git_email }}"

    - name: Create symlink from task to go-task
      become: true
      ansible.builtin.file:
        src: "/usr/bin/go-task"
        dest: "/usr/bin/task"
        state: link
        mode: "0755"

    - name: Install rust
      shell: "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile default"

    - name: Install deno
      shell: "curl -fsSL https://deno.land/install.sh | sh"

    - name: Install babashka
      shell: "curl -fsSL https://github.com/babashka/babashka/raw/master/install | sh"
