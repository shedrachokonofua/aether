---
# Firecrawl architecture changed - now uses harness.js + RabbitMQ instead of separate workers
- name: Deploy Firecrawl pod
  hosts: ai-tool-stack
  gather_facts: true
  roles:
    - common
  vars:
    firecrawl_env:
      HOST: "0.0.0.0"
      ENV: "local"
      NUM_WORKERS_PER_QUEUE: 8
      REDIS_URL: "redis://localhost:6379"
      REDIS_RATE_LIMIT_URL: "redis://localhost:6379"
      PLAYWRIGHT_MICROSERVICE_URL: "http://localhost:3000/scrape"
      # Database - use connection string format
      NUQ_DATABASE_URL: "postgres://postgres:{{ secrets.firecrawl.database_password }}@localhost:5432/postgres"
      # RabbitMQ - now required
      NUQ_RABBITMQ_URL: "amqp://localhost:5672"
      USE_DB_AUTHENTICATION: "false"
      OPENAI_BASE_URL: "https://litellm.home.shdr.ch/v1"
      OPENAI_API_KEY: "{{ secrets.litellm.virtual_keys.firecrawl }}"
      MODEL_NAME: "aether/qwen3:8b"
      MODEL_EMBEDDING_NAME: "aether/qwen3-embedding:4b"
      BULL_AUTH_KEY: "{{ secrets.firecrawl.bull_auth_key }}"
      TEST_API_KEY: "{{ secrets.firecrawl.api_key }}"
      LOGGING_LEVEL: "debug"
      SEARXNG_ENDPOINT: "https://searxng.home.shdr.ch"
  tasks:
    - name: Create Firecrawl pod
      containers.podman.podman_pod:
        name: firecrawl
        state: quadlet
        restart_policy: unless-stopped
        recreate: true
        ports:
          - "{{ vm.ai_tool_stack.ports.firecrawl }}:3002"
          - "{{ vm.ai_tool_stack.ports.firecrawl_mcp }}:3007"
        quadlet_options:
          - |
            [Install]
            WantedBy=default.target

    - name: Create redis volume
      containers.podman.podman_volume:
        name: firecrawl_redis_data
        state: quadlet

    - name: Create postgres volume
      containers.podman.podman_volume:
        name: firecrawl_pg_data
        state: quadlet

    - name: Create redis container
      containers.podman.podman_container:
        name: firecrawl-redis
        image: docker.io/redis:alpine
        state: quadlet
        pod: firecrawl.pod
        command: ["redis-server", "--bind", "0.0.0.0"]
        volumes:
          - firecrawl_redis_data.volume:/data:Z

    - name: Create rabbitmq container
      containers.podman.podman_container:
        name: firecrawl-rabbitmq
        image: docker.io/rabbitmq:3-management
        state: quadlet
        pod: firecrawl.pod
        command: ["rabbitmq-server"]
        healthcheck: "rabbitmq-diagnostics -q check_running"
        healthcheck_interval: 5s
        healthcheck_timeout: 5s
        healthcheck_retries: 3
        healthcheck_start_period: 5s

    - name: Create postgres container
      containers.podman.podman_container:
        name: firecrawl-postgres
        image: ghcr.io/firecrawl/nuq-postgres:latest
        state: quadlet
        pod: firecrawl.pod
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: "{{ secrets.firecrawl.database_password }}"
          POSTGRES_DB: postgres
        volumes:
          - firecrawl_pg_data.volume:/var/lib/postgresql/data:Z

    - name: Create playwright-service container
      containers.podman.podman_container:
        name: firecrawl-playwright
        image: ghcr.io/firecrawl/playwright-service:latest
        state: quadlet
        pod: firecrawl.pod
        env:
          PORT: "3000"
          MAX_CONCURRENT_PAGES: "10"
          PROXY_SERVER: "socks5://proxy.home.shdr.ch:1080"

    # Single API container with harness.js - manages workers internally
    - name: Create api container
      containers.podman.podman_container:
        name: firecrawl-api
        image: ghcr.io/firecrawl/firecrawl:latest
        pull: always
        state: quadlet
        pod: firecrawl.pod
        ulimits:
          - nofile=65535:65535
        env: "{{ firecrawl_env | combine({'PORT': '3002', 'EXTRACT_WORKER_PORT': '3004', 'WORKER_PORT': '3005'}) }}"
        command: ["node", "dist/src/index.js"]
        quadlet_options:
          - |
            [Unit]
            After=firecrawl-redis.service firecrawl-rabbitmq.service firecrawl-postgres.service firecrawl-playwright.service

    # Old separate worker containers removed - harness.js handles this now

    - name: Create firecrawl-mcp container
      containers.podman.podman_container:
        name: firecrawl-mcp
        image: docker.io/node:22-alpine
        state: quadlet
        pod: firecrawl.pod
        env:
          PORT: "3007"
          HOST: "0.0.0.0"
          HTTP_STREAMABLE_SERVER: "true"
          FIRECRAWL_API_KEY: "{{ secrets.firecrawl.api_key }}"
          FIRECRAWL_API_URL: "https://firecrawl.home.shdr.ch"
        command: ["npx", "-y", "firecrawl-mcp"]

    - name: Reload systemd
      systemd:
        daemon_reload: yes
        scope: user

    - name: Start firecrawl quadlet
      systemd:
        name: firecrawl-pod
        state: restarted
        scope: user

    - name: Wait for firecrawl API to start
      wait_for:
        port: "{{ vm.ai_tool_stack.ports.firecrawl }}"
        host: 127.0.0.1
        timeout: 120

    - name: Wait for firecrawl MCP to start
      wait_for:
        port: "{{ vm.ai_tool_stack.ports.firecrawl_mcp }}"
        host: 127.0.0.1
        timeout: 120
