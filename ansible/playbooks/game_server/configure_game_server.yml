---
- name: Configure game server
  hosts: game-server
  gather_facts: true
  roles:
    - common
    # - vm_baseline
    # - vm_monitoring_agent
  tasks:
    - name: Resize partition to maximum size
      command: parted -s /dev/sda resizepart 4 100%
      become: true
      ignore_errors: true

    - name: Remount /sysroot as read-write
      command: mount -o remount,rw /sysroot
      become: true

    - name: Resize Btrfs filesystem to maximum
      command: btrfs filesystem resize max /sysroot
      become: true

    - name: Setup sunshine
      command: ujust setup-sunshine install

    - name: Start sunshine service on boot
      command: ujust setup-sunshine autostart

    - name: Copy sunshine config
      copy:
        src: sunshine.conf
        dest: "{{ ansible_env.HOME }}/.config/sunshine/sunshine.conf"

    - name: Restart sunshine service
      systemd:
        name: sunshine
        state: restarted
        scope: user

    - name: Set sunshine credentials
      command: sunshine --creds {{ vm.game_server.admin }} {{ secrets.game_server_password }}

    - name: Copy powerdevilrc
      copy:
        src: powerdevilrc
        dest: "{{ ansible_env.HOME }}/.config/powerdevilrc"

    - name: Copy kscreenlockerrc
      copy:
        src: kscreenlockerrc
        dest: "{{ ansible_env.HOME }}/.config/kscreenlockerrc"

    - name: Restart PowerDevil service
      systemd:
        name: plasma-powerdevil
        state: restarted
        scope: user
      ignore_errors: yes

    - name: Install packages
      flatpak:
        name:
          - org.chromium.Chromium
          - net.pcsx2.PCSX2
          - net.rpcs3.RPCS3
          - com.steamgriddb.steam-rom-manager
        state: present
      become: true

    # Cleanup old NFS mount (migrated to CephFS)
    - name: Unmount old NFS gaming mount if present
      ansible.posix.mount:
        path: /mnt/gaming
        state: unmounted
      become: true
      ignore_errors: true

    - name: Remove old NFS gaming mount from fstab
      ansible.posix.mount:
        path: /mnt/gaming
        state: absent
      become: true
      ignore_errors: true

    - name: Remove old lineinfile fstab entry for gaming NFS
      lineinfile:
        path: /etc/fstab
        regexp: '.*:/mnt/nvme/data/gaming.*'
        state: absent
      become: true
      ignore_errors: true

    - name: Check if ceph-common is already installed
      command: rpm -q ceph-common
      register: ceph_installed
      changed_when: false
      failed_when: false
      become: true

    - name: Install CephFS client via rpm-ostree
      command: rpm-ostree install --apply-live --idempotent -y ceph-common
      become: true
      when: ceph_installed.rc != 0
      async: 300
      poll: 10

    - name: Create Ceph config directory
      file:
        path: /etc/ceph
        state: directory
        mode: "0755"
      become: true

    - name: Write Ceph admin secret
      copy:
        content: "{{ secrets.ceph.admin_key }}"
        dest: /etc/ceph/ceph.client.admin.secret
        mode: "0600"
      become: true

    - name: Write minimal Ceph config
      copy:
        content: |
          [global]
          mon_host = 192.168.2.202,192.168.2.204,192.168.2.205
        dest: /etc/ceph/ceph.conf
        mode: "0644"
      become: true

    - name: Mount CephFS for gaming
      mount:
        path: /mnt/gaming
        src: "192.168.2.202,192.168.2.204,192.168.2.205:/gaming"
        fstype: ceph
        opts: name=admin,secretfile=/etc/ceph/ceph.client.admin.secret,_netdev,noatime
        state: mounted
      become: true

    - name: Set ownership on entire gaming directory (recursive)
      file:
        path: /mnt/gaming
        owner: "{{ vm.game_server.admin }}"
        group: "{{ vm.game_server.admin }}"
        recurse: yes
        state: directory
      become: true

    - name: Create user gaming directory symlink
      file:
        src: /mnt/gaming
        dest: "/home/{{ vm.game_server.admin }}/gaming"
        state: link
        owner: "{{ vm.game_server.admin }}"
        group: "{{ vm.game_server.admin }}"

    - name: Grant emulators user access to game mount point
      command: flatpak override --user {{ item }} --filesystem=/mnt/gaming
      loop:
        - net.pcsx2.PCSX2
        - net.rpcs3.RPCS3
      ignore_errors: true
